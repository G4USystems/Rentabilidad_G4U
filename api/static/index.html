<!DOCTYPE html>
<html lang="es">
<head>
    <title>G4U - Dashboard Financiero</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

        /* Layout */
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background: var(--card); border-right: 1px solid var(--border); padding: 20px 0; position: fixed; height: 100vh; overflow: hidden; transition: width 0.2s, transform 0.2s; display: flex; flex-direction: column; }
        .sidebar.collapsed { width: 0; padding: 0; overflow: hidden; }
        .main { flex: 1; margin-left: 240px; padding: 24px; transition: margin-left 0.2s; }
        .main.expanded { margin-left: 0; }
        .sidebar-toggle { position: fixed; top: 20px; left: 10px; z-index: 100; background: var(--primary); color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; display: none; }
        .sidebar.collapsed + .main .sidebar-toggle { display: block; }

        /* Sidebar */
        .logo { padding: 0 20px 20px; font-size: 20px; font-weight: 700; color: var(--primary); }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--bg); color: var(--text); }
        .nav-item.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); font-weight: 500; }
        .nav-item svg { width: 20px; height: 20px; margin-right: 12px; }
        .nav-section { padding: 16px 20px 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .sidebar nav { display: flex; flex-direction: column; flex: 1; overflow-y: auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-actions { display: flex; gap: 12px; align-items: center; }

        /* Cards */
        .card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .kpi { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); transition: box-shadow 0.2s, transform 0.2s; }
        .kpi:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .kpi-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }
        .kpi-value { font-size: 28px; font-weight: 700; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; letter-spacing: -1px; }
        .kpi-value.positive { color: var(--success); }
        .kpi-value.negative { color: var(--danger); }
        .kpi-change { font-size: 12px; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
        .kpi-change.up { color: var(--success); }
        .kpi-change.down { color: var(--danger); }

        /* Filters */
        .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 13px; color: var(--text-muted); }
        select, input[type="date"], input[type="text"], input[type="number"] {
            padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--card);
        }
        select:focus, input:focus { outline: none; border-color: var(--primary); }

        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.15s; }
        th.sortable:hover { background: #e2e8f0; }
        th.sortable.active { background: #dbeafe; color: var(--primary); }
        th.sortable span { font-size: 10px; margin-left: 4px; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tbody tr { transition: background 0.15s; }
        tbody tr:nth-child(even) { background: #fafbfc; }
        tbody tr:hover { background: #f0f9ff; }
        .amount { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-weight: 600; font-size: 14px; letter-spacing: -0.5px; }
        .amount.positive { color: var(--success); }
        .amount.negative { color: var(--danger); }

        /* P&L Statement */
        .pl-section { margin-bottom: 16px; }
        .pl-section-header { padding: 12px 16px; background: var(--bg); font-weight: 600; color: var(--text); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .pl-row { display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid #f1f5f9; }
        .pl-row:hover { background: #fafafa; }
        .pl-row.indent { padding-left: 32px; }
        .pl-row.total { font-weight: 600; background: var(--bg); }
        .pl-row.grand-total { font-weight: 700; background: #f0f9ff; border-top: 2px solid var(--primary); }
        .pl-label { color: var(--text); }
        .pl-amount { font-family: 'SF Mono', Monaco, monospace; }

        /* Settings Tables - Compact */
        .settings-section table th { padding: 8px 12px; }
        .settings-section table td { padding: 8px 12px; }
        .settings-section table .btn { padding: 4px 10px; font-size: 12px; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }
        .tab:hover { color: var(--text); }
        .tab.active { background: var(--card); color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }

        /* Status */
        .status { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status.ok { background: #dcfce7; color: #166534; }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.error { background: #fee2e2; color: #991b1b; }

        /* Column Visibility Dropdown */
        .column-toggle { position: relative; display: inline-block; }
        .column-toggle-btn { background: transparent; border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px; color: var(--text-muted); }
        .column-toggle-btn:hover { background: var(--bg); }
        .column-toggle-menu { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px 0; min-width: 150px; z-index: 100; display: none; }
        .column-toggle-menu.show { display: block; }
        .column-toggle-menu label { display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; font-size: 13px; }
        .column-toggle-menu label:hover { background: var(--bg); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* Project cards */
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .project-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: box-shadow 0.2s, transform 0.2s; }
        .project-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .client-section:hover { background: #f8fafc; }
        .project-name { font-weight: 600; font-size: 16px; margin-bottom: 12px; }
        .project-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .project-stat { }
        .project-stat-label { font-size: 12px; color: var(--text-muted); }
        .project-stat-value { font-size: 18px; font-weight: 600; }
        .project-bar { height: 8px; background: var(--bg); border-radius: 4px; margin-top: 16px; overflow: hidden; }
        .project-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .project-bar-fill.positive { background: var(--success); }
        .project-bar-fill.negative { background: var(--danger); }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 640px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }

        .hidden { display: none !important; }
        .text-muted { color: var(--text-muted); }
        .text-sm { font-size: 13px; }
        .mt-4 { margin-top: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .settings-section.hidden { display: none; }
        .pl-tab-content.hidden { display: none; }

        /* Modern amount font */
        .amount { font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; font-weight: 600; font-feature-settings: 'tnum'; }

        /* Type badges */
        .type-badge { display:inline-block; padding:3px 8px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase; }
        .type-badge.ingreso { background:#dcfce7; color:#166534; }
        .type-badge.gasto { background:#fee2e2; color:#991b1b; }
        .type-badge.egreso { background:#fee2e2; color:#991b1b; } /* Legacy support */

        /* Top list items */
        .top-item { display:flex; justify-content:space-between; align-items:center; padding:10px 16px; border-bottom:1px solid var(--border); transition:background 0.15s; }
        .top-item:last-child { border-bottom:none; }
        .top-item.clickable:hover { background:var(--bg); }
        .top-item-name { font-weight:500; }
        .top-item-amount { font-family:'Inter',sans-serif; font-weight:600; }

        /* Client cards in P&L */
        .client-section { margin-bottom:24px; }
        .client-header { background:var(--bg); padding:16px; border-radius:8px 8px 0 0; border:1px solid var(--border); border-bottom:none; }
        .client-header h3 { margin:0; font-size:16px; }
        .client-projects { border:1px solid var(--border); border-radius:0 0 8px 8px; }

        /* Excluded transactions */
        tr.excluded { opacity: 0.5; background: #f8fafc; }
        tr.excluded td { text-decoration: line-through; color: var(--text-muted); }
        tr.excluded .amount { text-decoration: line-through; }
        .badge-excluded { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; background: #fef3c7; color: #92400e; margin-left: 8px; }
        .btn-exclude { padding: 4px 8px; font-size: 11px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); background: white; color: var(--text-muted); }
        .btn-exclude:hover { background: #fee2e2; border-color: var(--danger); color: var(--danger); }
        .btn-exclude.active { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .btn-exclude.active:hover { background: #dcfce7; border-color: var(--success); color: #166534; }

        /* Refund/reversed transactions */
        .badge-refund { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; background: #fce7f3; color: #be185d; margin-left: 8px; }
        tr.refund { background: #fdf2f8; }
        tr.refund:hover { background: #fce7f3; }

        /* Loading spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo" style="display:flex;justify-content:space-between;align-items:center;">
                <span>G4U Finance</span>
                <button onclick="toggleSidebar()" style="background:none;border:none;color:white;cursor:pointer;font-size:18px;padding:4px;">◀</button>
            </div>
            <!-- User Profile -->
            <div id="user-profile" style="padding:12px 16px;border-bottom:1px solid var(--border);margin-bottom:8px;display:none;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <div id="user-avatar-container" style="width:36px;height:36px;border-radius:50%;overflow:hidden;background:var(--primary);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <img id="user-avatar" src="" style="width:100%;height:100%;object-fit:cover;display:none;" alt="">
                        <span id="user-initials" style="color:white;font-size:14px;font-weight:600;"></span>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div id="user-name" style="font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                        <div id="user-email" style="font-size:11px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                    </div>
                </div>
            </div>
            <nav>
                <div class="nav-item active" data-view="dashboard">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    Dashboard
                </div>
                <div class="nav-item" data-view="pl">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Estado P&L
                </div>
                <div class="nav-item" data-view="transactions">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    Transacciones
                </div>
                <div class="nav-section">Inteligencia</div>
                <div class="nav-item" data-view="ai-brain">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                    AI Brain
                </div>
                <div class="nav-section">Configuracion</div>
                <div class="nav-item" data-view="settings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Ajustes
                </div>
                <div style="flex:1;"></div>
                <a href="/auth/logout" class="nav-item" style="margin-top:auto;color:#ef4444;text-decoration:none;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    Cerrar sesion
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main" id="main">
            <button class="sidebar-toggle" onclick="toggleSidebar()">☰ Menu</button>
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view active">
                <div class="header">
                    <h1>Dashboard <span style="font-size: 0.4em; font-weight: normal; color: #888; margin-left: 10px;">v2.6 · Actualizado: 11 Ene 2026, 23:30</span></h1>
                    <div class="header-actions">
                        <span id="status-indicator"></span>
                        <span id="last-sync" class="text-muted text-sm"></span>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Periodo:</label>
                        <select id="filter-period" onchange="applyFilters()">
                            <option value="all" selected>Todo el tiempo</option>
                            <option value="30days">Ultimos 30 dias</option>
                            <option value="month">Este mes</option>
                            <option value="quarter">Este trimestre</option>
                            <option value="year">Este año</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div class="filter-group hidden" id="custom-dates">
                        <input type="date" id="filter-from" onchange="applyFilters()">
                        <span>a</span>
                        <input type="date" id="filter-to" onchange="applyFilters()">
                    </div>
                </div>

                <!-- KPIs principales -->
                <div class="kpi-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="kpi">
                        <div class="kpi-label">Saldo Actual</div>
                        <div class="kpi-value" id="kpi-balance">-</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">Ingresos</div>
                        <div class="kpi-value positive" id="kpi-income">-</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">Gastos</div>
                        <div class="kpi-value negative" id="kpi-expenses">-</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">Resultado Neto</div>
                        <div class="kpi-value" id="kpi-net">-</div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-label">Rentabilidad</div>
                        <div class="kpi-value" id="kpi-margin">-</div>
                    </div>
                </div>

                <!-- Resumen general -->
                <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                    <div class="kpi" style="text-align:center;">
                        <div class="kpi-label">Clientes Activos</div>
                        <div class="kpi-value" id="kpi-clients">-</div>
                    </div>
                    <div class="kpi" style="text-align:center;">
                        <div class="kpi-label">Proyectos Activos</div>
                        <div class="kpi-value" id="kpi-projects">-</div>
                    </div>
                    <div class="kpi" style="text-align:center;">
                        <div class="kpi-label">Transacciones</div>
                        <div class="kpi-value" id="kpi-transactions">-</div>
                    </div>
                    <div class="kpi" style="text-align:center;">
                        <div class="kpi-label">Equipo</div>
                        <div class="kpi-value" id="kpi-team">-</div>
                    </div>
                </div>

                <!-- Graficos de distribucion -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- Grafico gastos -->
                    <div class="card">
                        <div class="card-header">Distribucion de Gastos</div>
                        <div class="card-body" style="padding:12px;">
                            <div style="height:160px;"><canvas id="chart-expenses"></canvas></div>
                            <div id="chart-expenses-legend"></div>
                        </div>
                    </div>
                    <!-- Grafico ingresos -->
                    <div class="card">
                        <div class="card-header">Distribucion de Ingresos</div>
                        <div class="card-body" style="padding:12px;">
                            <div style="height:160px;"><canvas id="chart-income"></canvas></div>
                            <div id="chart-income-legend"></div>
                        </div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- Top Gastos -->
                    <div class="card">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                            <span>Top Gastos</span>
                            <select id="top-expenses-view" onchange="renderTops()" style="width:auto;padding:4px 8px;font-size:12px;">
                                <option value="g4u_category">Por Categoria G4U</option>
                                <option value="qonto_category">Por Categoria Qonto</option>
                                <option value="transaction">Por Transaccion</option>
                            </select>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <div id="top-expenses" style="max-height:250px;overflow-y:auto;"></div>
                        </div>
                    </div>
                    <!-- Top Ingresos -->
                    <div class="card">
                        <div class="card-header">Top Ingresos</div>
                        <div class="card-body" style="padding:0;">
                            <div id="top-income" style="max-height:250px;overflow-y:auto;"></div>
                        </div>
                    </div>
                    <!-- Top Clientes -->
                    <div class="card">
                        <div class="card-header">Top Clientes</div>
                        <div class="card-body" style="padding:0;">
                            <div id="top-clients" style="max-height:250px;overflow-y:auto;"></div>
                        </div>
                    </div>
                    <!-- Top Proyectos -->
                    <div class="card">
                        <div class="card-header">Top Proyectos</div>
                        <div class="card-body" style="padding:0;">
                            <div id="top-projects" style="max-height:250px;overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P&L View -->
            <div id="view-pl" class="view">
                <div class="header">
                    <h1>Estado de Resultados (P&L)</h1>
                    <div class="header-actions" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                        <select id="pl-period" onchange="updatePLDateRange(); renderPL()">
                            <option value="all">Todo el tiempo</option>
                            <option value="month">Este mes</option>
                            <option value="quarter">Este trimestre</option>
                            <option value="year">Este año</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <div id="pl-custom-dates" class="hidden" style="display:flex;gap:8px;align-items:center;">
                            <input type="date" id="pl-date-from" onchange="document.getElementById('pl-period').value='custom'; renderPL()" style="padding:6px;font-size:13px;">
                            <span style="color:var(--text-muted);">-</span>
                            <input type="date" id="pl-date-to" onchange="document.getElementById('pl-period').value='custom'; renderPL()" style="padding:6px;font-size:13px;">
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;" title="Mostrar montos sin IVA (netos)">
                            <input type="checkbox" id="pl-exclude-vat" onchange="renderPL(); renderPLProjects(); renderPLClients();">
                            Sin IVA
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;">
                            <input type="checkbox" id="pl-comparative" onchange="renderPL()">
                            Comparar periodo anterior
                        </label>
                        <button class="btn btn-outline btn-sm" onclick="exportPL('csv')" style="font-size:12px;">Exportar CSV</button>
                        <button class="btn btn-outline btn-sm" onclick="exportPL('excel')" style="font-size:12px;">Exportar Excel</button>
                    </div>
                </div>

                <!-- Tabs P&L -->
                <div class="tabs mb-4">
                    <div class="tab active" onclick="showPLTab('global', event)">Global</div>
                    <div class="tab" onclick="showPLTab('projects', event)">Por Proyecto</div>
                    <div class="tab" onclick="showPLTab('clients', event)">Por Cliente</div>
                </div>

                <!-- Vista Global -->
                <div id="pl-global" class="pl-tab-content">
                    <div class="card">
                        <div class="card-body" style="padding:0;" id="pl-statement">
                            <div style="padding:40px;text-align:center;color:var(--text-muted);">Cargando...</div>
                        </div>
                    </div>
                </div>

                <!-- Vista por Proyecto -->
                <div id="pl-projects" class="pl-tab-content hidden">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
                        <div style="display:flex;gap:12px;align-items:center;">
                            <select id="pl-projects-status" onchange="renderPLProjects()" style="width:auto;">
                                <option value="all">Todos los proyectos</option>
                                <option value="Active" selected>Solo Activos</option>
                                <option value="Completed">Solo Completados</option>
                            </select>
                            <select id="pl-projects-sort" onchange="renderPLProjects()" style="width:auto;">
                                <option value="margin">Ordenar por Margen</option>
                                <option value="income">Ordenar por Ingresos</option>
                                <option value="name">Ordenar por Nombre</option>
                            </select>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;">
                            <input type="checkbox" id="pl-projects-exclude-unassigned" checked onchange="renderPLProjects()">
                            Excluir sin asignar
                        </label>
                    </div>
                    <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:20px;">
                        <div class="kpi">
                            <div class="kpi-label">Proyectos</div>
                            <div class="kpi-value" id="pl-projects-count">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Ingresos Totales</div>
                            <div class="kpi-value positive" id="pl-projects-income">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Margen Global</div>
                            <div class="kpi-value" id="pl-projects-margin">-</div>
                        </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                            Distribucion por Proyecto
                            <select id="pl-projects-chart-type" onchange="renderPLProjectsChart()" style="width:auto;">
                                <option value="margin">Margen %</option>
                                <option value="income-expense">Ingresos vs Gastos</option>
                            </select>
                        </div>
                        <div class="card-body" style="padding:12px;">
                            <canvas id="chart-projects" height="120"></canvas>
                        </div>
                    </div>
                    <div class="project-grid" id="pl-projects-grid">
                        <div style="padding:40px;text-align:center;color:var(--text-muted);">Cargando proyectos...</div>
                    </div>
                </div>

                <!-- Vista por Cliente -->
                <div id="pl-clients" class="pl-tab-content hidden">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
                        <div style="display:flex;gap:12px;align-items:center;">
                            <select id="pl-clients-sort" onchange="renderPLClients()" style="width:auto;">
                                <option value="margin">Ordenar por Margen</option>
                                <option value="income">Ordenar por Ingresos</option>
                                <option value="name">Ordenar por Nombre</option>
                            </select>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;">
                            <input type="checkbox" id="pl-clients-exclude-unassigned" checked onchange="renderPLClients()">
                            Excluir sin asignar
                        </label>
                    </div>

                    <!-- Alerta margen negativo -->
                    <div id="pl-clients-alert" class="hidden" style="margin-bottom:16px;padding:12px 16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#991b1b;">
                        <strong>⚠ Alerta:</strong> <span id="pl-clients-alert-text"></span>
                    </div>

                    <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom:20px;">
                        <div class="kpi">
                            <div class="kpi-label">Clientes</div>
                            <div class="kpi-value" id="pl-clients-count">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Ingresos Totales</div>
                            <div class="kpi-value positive" id="pl-clients-income">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Margen Global</div>
                            <div class="kpi-value" id="pl-clients-margin">-</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi-label">Top Cliente</div>
                            <div class="kpi-value" id="pl-clients-top" style="font-size:16px;">-</div>
                        </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                            Distribucion por Cliente
                            <select id="pl-clients-chart-type" onchange="renderPLClientsChart()" style="width:auto;">
                                <option value="margin">Margen %</option>
                                <option value="income-expense">Ingresos vs Gastos</option>
                            </select>
                        </div>
                        <div class="card-body" style="padding:12px;">
                            <canvas id="chart-clients" height="120"></canvas>
                        </div>
                    </div>
                    <div id="pl-clients-grid">
                        <div style="padding:40px;text-align:center;color:var(--text-muted);">Cargando clientes...</div>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div id="view-transactions" class="view">
                <div class="header">
                    <h1>Transacciones</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openModal('add-transaction')">+ Nueva Transaccion</button>
                    </div>
                </div>

                <div class="filters" style="flex-wrap:wrap;">
                    <div class="filter-group">
                        <label>Tipo:</label>
                        <select id="tx-filter-type" onchange="renderTransactions()">
                            <option value="">Todos</option>
                            <option value="credit">Ingresos</option>
                            <option value="debit">Gastos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Cat. Qonto:</label>
                        <select id="tx-filter-qonto-cat" onchange="renderTransactions()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Cat. G4U:</label>
                        <select id="tx-filter-g4u-cat" onchange="renderTransactions()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Proyecto:</label>
                        <select id="tx-filter-project" onchange="renderTransactions()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Cliente:</label>
                        <select id="tx-filter-client" onchange="renderTransactions()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Asignacion:</label>
                        <select id="tx-filter-assigned" onchange="renderTransactions()">
                            <option value="">Todas</option>
                            <option value="assigned">Asignadas (100%)</option>
                            <option value="unassigned">Sin asignar</option>
                            <option value="partial">Parcialmente asignadas</option>
                            <option value="no_category">Sin Categoria</option>
                            <option value="no_project">Sin Proyecto</option>
                            <option value="no_client">Sin Cliente</option>
                            <option value="excluded">Excluidas de reportes</option>
                            <option value="not_excluded">No excluidas</option>
                            <option value="refund">Devoluciones</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Desde:</label>
                        <input type="date" id="tx-filter-from" onchange="renderTransactions()">
                    </div>
                    <div class="filter-group">
                        <label>Hasta:</label>
                        <input type="date" id="tx-filter-to" onchange="renderTransactions()">
                    </div>
                    <div class="filter-group">
                        <label>Buscar:</label>
                        <input type="text" id="tx-search" placeholder="Descripcion..." onkeyup="renderTransactions()">
                    </div>
                </div>

                <div class="card">
                    <div id="bulk-actions" class="hidden" style="padding:12px 16px;background:var(--primary);color:white;display:flex;justify-content:space-between;align-items:center;">
                        <span><strong id="selected-count">0</strong> transacciones seleccionadas</span>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm" style="background:white;color:var(--primary);" onclick="openBulkAllocation()">Asignar Seleccionadas</button>
                            <button class="btn btn-sm btn-outline" style="border-color:white;color:white;" onclick="clearSelection()">Cancelar</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding:0;overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:40px;"><input type="checkbox" id="select-all-tx" onchange="toggleSelectAll(this.checked)"></th>
                                    <th class="sortable" onclick="sortTransactions('settled_at')">Fecha <span id="sort-settled_at"></span></th>
                                    <th class="sortable" onclick="sortTransactions('counterparty_name')">Descripcion <span id="sort-counterparty_name"></span></th>
                                    <th class="sortable" onclick="sortTransactions('side')">Tipo <span id="sort-side"></span></th>
                                    <th class="sortable" onclick="sortTransactions('qonto_category')">Cat. Qonto <span id="sort-qonto_category"></span></th>
                                    <th class="sortable" onclick="sortTransactions('category')">Cat. G4U <span id="sort-category"></span></th>
                                    <th class="sortable" onclick="sortTransactions('project')">Proyecto <span id="sort-project"></span></th>
                                    <th class="sortable" onclick="sortTransactions('client')">Cliente <span id="sort-client"></span></th>
                                    <th class="sortable" onclick="sortTransactions('vat_amount')" style="text-align:right">IVA <span id="sort-vat_amount"></span></th>
                                    <th class="sortable" onclick="sortTransactions('amount')" style="text-align:right">Monto <span id="sort-amount"></span></th>
                                    <th class="sortable" onclick="sortTransactions('assigned')" style="width:60px;text-align:center;">Asig. <span id="sort-assigned"></span></th>
                                    <th style="width:60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table">
                                <tr><td colspan="12" class="text-muted" style="text-align:center;padding:40px;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Settings View -->
            <div id="view-settings" class="view">
                <div class="header">
                    <h1>Ajustes</h1>
                </div>

                <!-- Tabs for Settings sections -->
                <div class="tabs mb-4">
                    <div class="tab active" onclick="showSettingsTab('connections', event)">Estado</div>
                    <div class="tab" onclick="showSettingsTab('team', event)">Equipo</div>
                    <div class="tab" onclick="showSettingsTab('clients', event)">Clientes</div>
                    <div class="tab" onclick="showSettingsTab('projects', event)">Proyectos</div>
                    <div class="tab" onclick="showSettingsTab('categories', event)">Categorias G4U</div>
                    <div class="tab" onclick="showSettingsTab('offerings', event)">Ofertas G4U</div>
                    <div class="tab" onclick="showSettingsTab('general-expenses', event)">Distribucion Mensual</div>
                </div>

                <!-- Connections Section -->
                <div id="settings-connections" class="settings-section">
                    <div class="card">
                        <div class="card-header">Estado del Sistema</div>
                        <div class="card-body">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                                <div>
                                    <h4 style="margin-bottom:12px;">Integraciones</h4>
                                    <div style="display:flex;gap:16px;margin-bottom:12px;">
                                        <div><strong>Qonto:</strong> <span id="status-qonto">-</span></div>
                                        <div><strong>Airtable:</strong> <span id="status-airtable">-</span></div>
                                    </div>
                                    <p class="text-sm text-muted">Las transacciones (incluyendo IVA) se sincronizan automaticamente al cargar la pagina.</p>
                                </div>
                                <div id="qonto-org-info" style="padding:16px;background:var(--bg);border-radius:8px;">
                                    <h4 style="margin-bottom:12px;">Organizacion Qonto</h4>
                                    <div><strong>Nombre:</strong> <span id="qonto-org-name">-</span></div>
                                    <div style="margin-top:8px;"><strong>Saldo:</strong> <span id="qonto-balance" style="font-size:20px;font-weight:600;">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Members Section -->
                <div id="settings-team" class="settings-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <span>Equipo</span>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <div class="column-toggle">
                                    <button class="column-toggle-btn" onclick="toggleColumnMenu('team')">⚙ Columnas</button>
                                    <div id="column-menu-team" class="column-toggle-menu">
                                        <label><input type="checkbox" checked onchange="toggleColumn('team', 0, this.checked)"> Nombre</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('team', 1, this.checked)"> Rol</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('team', 2, this.checked)"> Salario</label>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openModal('add-member')">+ Nuevo Miembro</button>
                            </div>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <table id="table-team">
                                <thead>
                                    <tr><th>Nombre</th><th>Rol</th><th style="text-align:right">Salario Mensual</th><th style="width:100px;"></th></tr>
                                </thead>
                                <tbody id="team-members-table">
                                    <tr><td colspan="4" class="text-muted" style="text-align:center;padding:20px;">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Clients Section -->
                <div id="settings-clients" class="settings-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <span>Clientes</span>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <div class="column-toggle">
                                    <button class="column-toggle-btn" onclick="toggleColumnMenu('clients')">⚙ Columnas</button>
                                    <div id="column-menu-clients" class="column-toggle-menu">
                                        <label><input type="checkbox" checked onchange="toggleColumn('clients', 0, this.checked)"> Nombre</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('clients', 1, this.checked)"> Contacto</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('clients', 2, this.checked)"> Email</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('clients', 3, this.checked)"> Telefono</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('clients', 4, this.checked)"> Estado</label>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openModal('add-client')">+ Nuevo Cliente</button>
                            </div>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <table id="table-clients">
                                <thead>
                                    <tr><th>Nombre</th><th>Contacto</th><th>Email</th><th>Telefono</th><th>Estado</th><th style="width:100px;"></th></tr>
                                </thead>
                                <tbody id="clients-table">
                                    <tr><td colspan="6" class="text-muted" style="text-align:center;padding:20px;">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div id="settings-projects" class="settings-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <span>Proyectos</span>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <div class="column-toggle">
                                    <button class="column-toggle-btn" onclick="toggleColumnMenu('projects')">⚙ Columnas</button>
                                    <div id="column-menu-projects" class="column-toggle-menu">
                                        <label><input type="checkbox" checked onchange="toggleColumn('projects', 0, this.checked)"> Nombre</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('projects', 1, this.checked)"> Cliente</label>
                                        <label><input type="checkbox" checked onchange="toggleColumn('projects', 2, this.checked)"> Estado</label>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openModal('add-project')">+ Nuevo Proyecto</button>
                            </div>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <table id="table-projects">
                                <thead>
                                    <tr><th>Titulo</th><th>Oferta G4U</th><th>Cliente</th><th>F. Inicio</th><th>F. Fin</th><th>Estado</th><th style="width:120px;"></th></tr>
                                </thead>
                                <tbody id="projects-table">
                                    <tr><td colspan="7" class="text-muted" style="text-align:center;padding:20px;">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Categories Section -->
                <div id="settings-categories" class="settings-section hidden">
                    <div class="card">
                        <div class="card-header">
                            Categorias G4U
                            <button class="btn btn-sm btn-primary" onclick="openModal('add-category')">+ Nueva Categoria G4U</button>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <table>
                                <thead>
                                    <tr><th>Nombre</th><th>Tipo</th><th style="width:100px;"></th></tr>
                                </thead>
                                <tbody id="categories-table">
                                    <tr><td colspan="3" class="text-muted" style="text-align:center;padding:20px;">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Monthly Distribution Section -->
                <div id="settings-general-expenses" class="settings-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <span>Distribucion Mensual de Gastos Generales</span>
                            <button class="btn btn-sm btn-success" onclick="saveMonthlyDistribution()">Guardar Cambios</button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">Configura como se distribuyen los gastos asignados al proyecto "General" entre los proyectos activos, mes a mes. El cliente se deriva automaticamente del proyecto.</p>

                            <!-- Month selector -->
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                                <button class="btn btn-sm btn-outline" onclick="changeDistributionMonth(-1)">&lt; Anterior</button>
                                <select id="distribution-month" onchange="loadMonthlyDistribution()" style="font-size:16px;font-weight:600;padding:8px 16px;">
                                    <!-- Options populated dynamically -->
                                </select>
                                <button class="btn btn-sm btn-outline" onclick="changeDistributionMonth(1)">Siguiente &gt;</button>
                            </div>

                            <!-- Month summary -->
                            <div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <strong>Gastos Generales del mes:</strong>
                                        <span id="month-general-expenses" style="font-size:20px;font-weight:600;margin-left:12px;">€0.00</span>
                                        <span class="text-muted" style="font-size:12px;margin-left:8px;">(gastos asignados al proyecto "General")</span>
                                    </div>
                                    <div>
                                        <strong>Distribuido:</strong>
                                        <span id="distribution-total-pct" style="font-size:18px;font-weight:600;margin-left:8px;">0%</span>
                                        <span id="distribution-total-amount" class="text-muted" style="font-size:14px;margin-left:8px;">(€0.00)</span>
                                    </div>
                                </div>
                                <!-- Progress bar -->
                                <div style="margin-top:12px;height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
                                    <div id="distribution-progress-bar" style="height:100%;background:var(--success);width:0%;transition:width 0.3s;"></div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div style="display:flex;gap:12px;margin-bottom:16px;">
                                <button class="btn btn-sm btn-outline" onclick="distributeMonthlyEqually()">Distribuir Equitativamente</button>
                                <button class="btn btn-sm btn-outline" onclick="clearMonthlyDistribution()">Limpiar</button>
                            </div>

                            <!-- Distribution table -->
                            <table>
                                <thead>
                                    <tr>
                                        <th>Proyecto</th>
                                        <th>Cliente</th>
                                        <th style="width:120px;text-align:right;">%</th>
                                        <th style="width:150px;text-align:right;">Monto</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-distribution-table">
                                    <tr><td colspan="4" class="text-muted" style="text-align:center;padding:20px;">Selecciona un mes para ver los proyectos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Ofertas G4U Section -->
                <div id="settings-offerings" class="settings-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <span>Ofertas G4U</span>
                            <button class="btn btn-sm btn-primary" onclick="addOffering()">+ Agregar Oferta</button>
                        </div>
                        <div class="card-body">
                            <p class="text-muted" style="margin-bottom:16px;">
                                Configura los tipos de servicio disponibles para asignar a proyectos.
                            </p>
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>ID (interno)</th>
                                        <th>Nombre</th>
                                        <th style="width:100px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="offerings-table">
                                    <tr><td colspan="3" class="text-muted" style="text-align:center;padding:20px;">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer" style="display:flex;justify-content:flex-end;gap:12px;padding:16px;">
                            <button class="btn btn-outline" onclick="loadOfferings()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveOfferings()">Guardar Cambios</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- AI Brain View -->
            <div id="view-ai-brain" class="view">
                <div class="header">
                    <h1>AI Brain - Simulaciones Financieras</h1>
                    <div class="header-actions">
                        <select id="ai-model-selector" onchange="saveAIModel()" style="padding:6px 12px;border-radius:6px;border:1px solid var(--border);">
                            <optgroup label="Groq (Ultra Rapido, Gratis)">
                                <option value="groq-llama3-70b">Llama 3 70B</option>
                                <option value="groq-mixtral">Mixtral 8x7B</option>
                            </optgroup>
                            <optgroup label="OpenAI - GPT-5 Series">
                                <option value="openai-gpt52">GPT-5.2 (Ultimo, Recomendado)</option>
                                <option value="openai-gpt51">GPT-5.1</option>
                                <option value="openai-gpt51-codex">GPT-5.1 Codex (Codigo)</option>
                                <option value="openai-gpt5">GPT-5</option>
                            </optgroup>
                            <optgroup label="OpenAI - GPT-4 Series">
                                <option value="openai-gpt4o">GPT-4o</option>
                                <option value="openai-gpt4o-mini">GPT-4o Mini (Economico)</option>
                                <option value="openai-gpt41">GPT-4.1</option>
                                <option value="openai-gpt41-mini">GPT-4.1 Mini</option>
                            </optgroup>
                            <optgroup label="OpenAI - Razonamiento">
                                <option value="openai-o3">o3 (Razonamiento Avanzado)</option>
                                <option value="openai-o3-mini">o3 Mini</option>
                                <option value="openai-o4-mini">o4 Mini</option>
                            </optgroup>
                            <optgroup label="Anthropic Claude 4.5">
                                <option value="anthropic-opus">Claude Opus 4.5 (Premium)</option>
                                <option value="anthropic-sonnet">Claude Sonnet 4.5 (Balanceado)</option>
                                <option value="anthropic-haiku">Claude Haiku 4.5 (Rapido)</option>
                            </optgroup>
                            <optgroup label="Google Gemini">
                                <option value="gemini-3-pro">Gemini 3 Pro</option>
                                <option value="gemini-3-flash">Gemini 3 Flash</option>
                                <option value="gemini-25-pro">Gemini 2.5 Pro</option>
                                <option value="gemini-25-flash">Gemini 2.5 Flash</option>
                            </optgroup>
                            <optgroup label="xAI Grok">
                                <option value="grok-2">Grok 2</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">Escenarios Rapidos</div>
                        <div class="card-body" style="display:flex;flex-wrap:wrap;gap:8px;">
                            <button class="btn btn-outline btn-sm" onclick="runAIScenario('projection')">Proyeccion 3 meses</button>
                            <button class="btn btn-outline btn-sm" onclick="runAIScenario('anomalies')">Detectar anomalias</button>
                            <button class="btn btn-outline btn-sm" onclick="runAIScenario('trends')">Analizar tendencias</button>
                            <button class="btn btn-outline btn-sm" onclick="runAIScenario('optimization')">Optimizar gastos</button>
                            <button class="btn btn-outline btn-sm" onclick="runAIScenario('whatif_revenue')">What-if: +20% ingresos</button>
                            <button class="btn btn-outline btn-sm" onclick="runAIScenario('whatif_cost')">What-if: -10% costos</button>
                        </div>
                    </div>

                    <!-- Summary Stats for AI -->
                    <div class="card">
                        <div class="card-header">Datos del Periodo Actual</div>
                        <div class="card-body">
                            <div id="ai-context-summary" style="font-size:13px;color:var(--text-muted);">
                                <p><strong>Ingresos:</strong> <span id="ai-total-income">-</span></p>
                                <p><strong>Gastos:</strong> <span id="ai-total-expenses">-</span></p>
                                <p><strong>Margen:</strong> <span id="ai-margin">-</span></p>
                                <p><strong>Transacciones:</strong> <span id="ai-tx-count">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        Chat con AI
                        <button class="btn btn-sm btn-outline" onclick="clearAIChat()" style="margin-left:auto;">Limpiar</button>
                    </div>
                    <div class="card-body" style="padding:0;">
                        <div id="ai-chat-messages" style="height:300px;overflow-y:auto;padding:16px;background:#f8fafc;">
                            <div class="ai-message ai-assistant" style="margin-bottom:12px;">
                                <div style="background:white;border-radius:12px;padding:12px 16px;max-width:80%;box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                                    Hola! Soy tu asistente financiero. Puedo ayudarte con:
                                    <ul style="margin:8px 0 0 16px;padding:0;">
                                        <li>Proyecciones de ingresos y gastos</li>
                                        <li>Analisis de tendencias y anomalias</li>
                                        <li>Simulaciones "What-if"</li>
                                        <li>Recomendaciones de optimizacion</li>
                                    </ul>
                                    Preguntame lo que quieras sobre tus finanzas!
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);">
                            <input type="text" id="ai-chat-input" placeholder="Escribe tu pregunta..."
                                   style="flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:8px;"
                                   onkeypress="if(event.key==='Enter')sendAIMessage()">
                            <button class="btn btn-primary" onclick="sendAIMessage()">Enviar</button>
                        </div>
                    </div>
                </div>

                <!-- Visualization Area -->
                <div class="card">
                    <div class="card-header">
                        Visualizacion
                        <div style="margin-left:auto;display:flex;gap:8px;">
                            <button class="btn btn-sm btn-outline" onclick="showAIView('chart')">Grafico</button>
                            <button class="btn btn-sm btn-outline" onclick="showAIView('table')">Tabla</button>
                            <button class="btn btn-sm btn-outline" onclick="showAIView('text')">Texto</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="ai-visualization" style="min-height:300px;">
                            <div id="ai-chart-container" style="display:none;">
                                <canvas id="ai-projection-chart"></canvas>
                            </div>
                            <div id="ai-table-container" style="display:none;">
                                <table id="ai-results-table">
                                    <thead><tr><th>Metrica</th><th>Actual</th><th>Proyectado</th><th>Variacion</th></tr></thead>
                                    <tbody id="ai-table-body"></tbody>
                                </table>
                            </div>
                            <div id="ai-text-container">
                                <div id="ai-text-output" style="white-space:pre-wrap;font-size:14px;line-height:1.6;color:var(--text-muted);padding:20px;text-align:center;">
                                    Selecciona un escenario o haz una pregunta para ver los resultados aqui.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="modal-add-transaction">
        <div class="modal">
            <div class="modal-header">
                <h3>Nueva Transaccion</h3>
                <button class="modal-close" onclick="closeModal('add-transaction')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="new-tx-type">
                            <option value="Expense">Gasto</option>
                            <option value="Income">Ingreso</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="new-tx-date">
                    </div>
                </div>
                <div class="form-group">
                    <label>Monto (EUR)</label>
                    <input type="number" step="0.01" id="new-tx-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Descripcion</label>
                    <input type="text" id="new-tx-description" placeholder="Descripcion del movimiento">
                </div>
                <div class="form-group">
                    <label>Contraparte</label>
                    <input type="text" id="new-tx-counterparty" placeholder="Nombre del cliente/proveedor">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('add-transaction')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Add Team Member Modal -->
    <div class="modal-overlay" id="modal-add-member">
        <div class="modal">
            <div class="modal-header">
                <h3>Nuevo Miembro del Equipo</h3>
                <button class="modal-close" onclick="closeModal('add-member')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="new-member-name" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <input type="text" id="new-member-role" placeholder="Ej: Desarrollador, Disenador...">
                </div>
                <div class="form-group">
                    <label>Salario Mensual (EUR)</label>
                    <input type="number" step="0.01" id="new-member-salary" placeholder="0.00">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('add-member')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveTeamMember()">Guardar</button>
            </div>
        </div>
    </div>


    <!-- Edit Team Member Modal -->
    <div class="modal-overlay" id="modal-edit-member">
        <div class="modal">
            <div class="modal-header">
                <h3>Editar Miembro</h3>
                <button class="modal-close" onclick="closeModal('edit-member')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-member-id">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="edit-member-name" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <input type="text" id="edit-member-role" placeholder="Ej: Desarrollador, Disenador...">
                </div>
                <div class="form-group">
                    <label>Salario Mensual (EUR)</label>
                    <input type="number" step="0.01" id="edit-member-salary" placeholder="0.00">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('edit-member')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateTeamMember()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal-overlay" id="modal-add-project">
        <div class="modal">
            <div class="modal-header">
                <h3>Nuevo Proyecto</h3>
                <button class="modal-close" onclick="closeModal('add-project')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Titulo del Proyecto</label>
                    <input type="text" id="new-project-name" placeholder="Ej: GTM - Paymatico">
                </div>
                <div class="form-group">
                    <label>Oferta G4U</label>
                    <select id="new-project-service">
                        <option value="">Selecciona una oferta</option>
                        <!-- Options loaded dynamically from Airtable -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="new-project-client">
                        <option value="">Sin cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="new-project-status">
                        <option value="Active">Activo</option>
                        <option value="Completed">Completado</option>
                        <option value="On Hold">En Pausa</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Inicio</label>
                        <input type="date" id="new-project-start-date">
                    </div>
                    <div class="form-group">
                        <label>Fecha Fin</label>
                        <input type="date" id="new-project-end-date">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('add-project')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveProject()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal-overlay" id="modal-edit-project">
        <div class="modal">
            <div class="modal-header">
                <h3>Editar Proyecto</h3>
                <button class="modal-close" onclick="closeModal('edit-project')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-project-id">
                <div class="form-group">
                    <label>Titulo del Proyecto</label>
                    <input type="text" id="edit-project-name" placeholder="Ej: GTM - Paymatico">
                </div>
                <div class="form-group">
                    <label>Oferta G4U</label>
                    <select id="edit-project-service">
                        <option value="">Selecciona una oferta</option>
                        <!-- Options loaded dynamically from Airtable -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="edit-project-client">
                        <option value="">Sin cliente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="edit-project-status">
                        <option value="Active">Activo</option>
                        <option value="Completed">Completado</option>
                        <option value="On Hold">En Pausa</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Inicio</label>
                        <input type="date" id="edit-project-start-date">
                    </div>
                    <div class="form-group">
                        <label>Fecha Fin</label>
                        <input type="date" id="edit-project-end-date">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('edit-project')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateProject()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal-overlay" id="modal-add-category">
        <div class="modal">
            <div class="modal-header">
                <h3>Nueva Categoria</h3>
                <button class="modal-close" onclick="closeModal('add-category')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre de la Categoria</label>
                    <input type="text" id="new-category-name" placeholder="Nombre de la categoria">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="new-category-type">
                        <option value="Expense">Gasto</option>
                        <option value="Income">Ingreso</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('add-category')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveCategory()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal-overlay" id="modal-edit-category">
        <div class="modal">
            <div class="modal-header">
                <h3>Editar Categoria</h3>
                <button class="modal-close" onclick="closeModal('edit-category')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-category-id">
                <div class="form-group">
                    <label>Nombre de la Categoria</label>
                    <input type="text" id="edit-category-name" placeholder="Nombre de la categoria">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="edit-category-type">
                        <option value="Expense">Gasto</option>
                        <option value="Income">Ingreso</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('edit-category')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateCategory()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="modal-add-client">
        <div class="modal">
            <div class="modal-header">
                <h3>Nuevo Cliente</h3>
                <button class="modal-close" onclick="closeModal('add-client')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="new-client-name" placeholder="Nombre de la empresa/cliente">
                </div>
                <div class="form-group">
                    <label>Contacto</label>
                    <input type="text" id="new-client-contact" placeholder="Persona de contacto">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="new-client-email" placeholder="email@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="text" id="new-client-phone" placeholder="+34...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="new-client-notes" rows="2" placeholder="Notas adicionales..." style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="new-client-status">
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('add-client')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveClient()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal-overlay" id="modal-edit-client">
        <div class="modal">
            <div class="modal-header">
                <h3>Editar Cliente</h3>
                <button class="modal-close" onclick="closeModal('edit-client')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-client-id">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="edit-client-name" placeholder="Nombre de la empresa/cliente">
                </div>
                <div class="form-group">
                    <label>Contacto</label>
                    <input type="text" id="edit-client-contact" placeholder="Persona de contacto">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit-client-email" placeholder="email@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="text" id="edit-client-phone" placeholder="+34...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="edit-client-notes" rows="2" placeholder="Notas adicionales..." style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="edit-client-status">
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('edit-client')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateClient()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Transaction Allocation Modal -->
    <div class="modal-overlay" id="modal-tx-allocation">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h2>Asignar a Proyectos/Clientes</h2>
                <span class="modal-close" onclick="closeModal('tx-allocation')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="tx-alloc-info" style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:8px;">
                    <div class="form-group" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);">Descripcion</label>
                        <input type="text" id="tx-alloc-desc-input" style="width:100%;font-weight:600;" onchange="saveTxDescription()">
                    </div>
                    <span class="text-muted">Monto: </span><span id="tx-alloc-amount">-</span>
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span class="text-muted">IVA:</span>
                            <select id="tx-alloc-vat-rate" onchange="updateVatFromRate()" style="width:120px;">
                                <option value="0">Sin IVA</option>
                                <option value="21">21% (General)</option>
                                <option value="10">10% (Reducido)</option>
                                <option value="4">4% (Super reducido)</option>
                            </select>
                            <span class="text-muted">=</span>
                            <span id="tx-alloc-vat-amount" style="font-weight:600;">€0.00</span>
                            <span class="text-muted" style="font-size:11px;">(Base: <span id="tx-alloc-base-amount">€0.00</span>)</span>
                        </div>
                    </div>
                </div>
                <div id="tx-alloc-list" style="margin-bottom:16px;">
                    <!-- Allocations will be rendered here -->
                </div>
                <div id="tx-alloc-total" style="margin-bottom:16px;padding:8px 12px;background:#f8fafc;border-radius:8px;display:flex;justify-content:space-between;">
                    <span>Total asignado:</span>
                    <strong id="tx-alloc-total-pct">0%</strong>
                </div>
                <div style="border-top:1px solid var(--border);padding-top:16px;">
                    <h4 style="margin-bottom:12px;">Agregar asignacion</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Categoria G4U</label>
                            <select id="tx-alloc-category" style="width:100%;">
                                <option value="">Sin categoria</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Proyecto</label>
                            <select id="tx-alloc-project" style="width:100%;">
                                <option value="">Sin proyecto</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="tx-alloc-client" style="width:100%;">
                                <option value="">Sin cliente</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:0 0 100px;">
                            <label>%</label>
                            <input type="number" id="tx-alloc-pct" min="0" max="100" value="100" style="width:100%;">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addTransactionAllocation()" style="width:100%;">+ Agregar Asignacion</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('tx-allocation')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Bulk Allocation Modal -->
    <div class="modal-overlay" id="modal-bulk-allocation">
        <div class="modal" style="max-width:650px;">
            <div class="modal-header">
                <h2>Asignar Multiples Transacciones</h2>
                <span class="modal-close" onclick="closeModal('bulk-allocation')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:16px;padding:12px;background:var(--bg);border-radius:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div><strong id="bulk-alloc-count">0</strong> transacciones seleccionadas</div>
                        <div class="text-muted">Total: <strong id="bulk-alloc-total-amount">$0</strong></div>
                    </div>
                </div>
                <div id="bulk-alloc-list" style="margin-bottom:16px;max-height:200px;overflow-y:auto;">
                    <div class="text-muted" style="text-align:center;padding:16px;">Sin asignaciones. Agrega asignaciones abajo.</div>
                </div>
                <div id="bulk-alloc-total-row" style="margin-bottom:16px;padding:8px 12px;background:#f8fafc;border-radius:8px;display:flex;justify-content:space-between;">
                    <span>Total asignado:</span>
                    <strong id="bulk-alloc-total-pct" style="color:inherit;">0%</strong>
                </div>
                <div style="border-top:1px solid var(--border);padding-top:16px;">
                    <h4 style="margin-bottom:12px;">Agregar asignacion</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Categoria G4U</label>
                            <select id="bulk-alloc-category" style="width:100%;">
                                <option value="">Sin categoria</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Proyecto</label>
                            <select id="bulk-alloc-project" style="width:100%;">
                                <option value="">Sin proyecto</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="bulk-alloc-client" style="width:100%;">
                                <option value="">Sin cliente</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:0 0 100px;">
                            <label>%</label>
                            <input type="number" id="bulk-alloc-pct" min="0" max="100" value="100" style="width:100%;">
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="addBulkAllocationRow()" style="width:100%;">+ Agregar Asignacion</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('bulk-allocation')">Cancelar</button>
                <button class="btn btn-primary" onclick="applyBulkAllocations()">Aplicar a Todas</button>
            </div>
        </div>
    </div>

    <script>
        // Chart.js global configuration
        Chart.defaults.font.family = "'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = '#64748b';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(30, 41, 59, 0.95)';
        Chart.defaults.plugins.tooltip.titleFont = { weight: 'bold', size: 13 };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.displayColors = true;
        Chart.defaults.plugins.tooltip.boxPadding = 4;
        Chart.defaults.animation.duration = 400;
        Chart.defaults.animation.easing = 'easeOutQuart';

        // Auth State
        var currentUser = null;

        // Check authentication on load
        function checkAuth() {
            fetch('/auth/me')
                .then(function(r) {
                    if (r.status === 401) {
                        window.location.href = '/auth/login-page';
                        return null;
                    }
                    return r.json();
                })
                .then(function(data) {
                    if (data && data.authenticated) {
                        currentUser = data.user;
                        updateUserDisplay();
                    }
                })
                .catch(function(e) {
                    console.error('Auth check failed:', e);
                });
        }

        function updateUserDisplay() {
            if (!currentUser) return;
            var profileEl = document.getElementById('user-profile');
            var avatarEl = document.getElementById('user-avatar');
            var initialsEl = document.getElementById('user-initials');
            var nameEl = document.getElementById('user-name');
            var emailEl = document.getElementById('user-email');

            if (profileEl) {
                profileEl.style.display = 'block';
            }

            // Handle avatar or initials
            if (avatarEl && initialsEl) {
                if (currentUser.picture) {
                    avatarEl.src = currentUser.picture;
                    avatarEl.style.display = 'block';
                    initialsEl.style.display = 'none';
                } else {
                    avatarEl.style.display = 'none';
                    var name = currentUser.name || currentUser.email || '';
                    var initials = name.split(' ').map(function(n) { return n[0]; }).join('').toUpperCase().slice(0, 2);
                    if (!initials && currentUser.email) {
                        initials = currentUser.email[0].toUpperCase();
                    }
                    initialsEl.textContent = initials;
                    initialsEl.style.display = 'block';
                }
            }

            if (nameEl) {
                nameEl.textContent = currentUser.name || '';
            }
            if (emailEl) {
                emailEl.textContent = currentUser.email || '';
            }
        }

        // Wrap fetch to handle 401 globally
        var originalFetch = window.fetch;
        window.fetch = function(url, options) {
            return originalFetch(url, options).then(function(response) {
                if (response.status === 401 && !url.includes('/auth/')) {
                    window.location.href = '/auth/login-page';
                }
                return response;
            });
        };

        // Check auth immediately
        checkAuth();

        // State
        var transactions = [];
        var categories = [];
        var projects = [];
        var clients = [];
        var filteredTransactions = [];
        var teamMembers = [];
        var transactionAllocations = [];
        var selectedTransactions = [];
        var currentAllocTxId = null;
        var sortField = 'settled_at';
        var sortDirection = 'desc';
        var qontoBalance = 0;
        var totalIncome = 0;  // Global for AI Brain context
        var totalExpenses = 0;  // Global for AI Brain context
        var expensesChart = null;
        var incomeChart = null;
        var projectsChart = null;
        var clientsChart = null;
        var plProjectsData = [];
        var plClientsData = [];
        var offerings = []; // Ofertas G4U from Airtable

        // Utilities
        function fmt(n, decimals) {
            var val = n || 0;
            // Default: 2 decimals for amounts >= 1000, 0 for smaller amounts
            if (decimals === undefined) {
                decimals = Math.abs(val) >= 1000 ? 0 : 2;
            }
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(val);
        }

        // Format number without currency symbol (for percentages, etc.)
        function fmtNum(n, decimals) {
            var val = n || 0;
            decimals = decimals !== undefined ? decimals : 1;
            return new Intl.NumberFormat('es-ES', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(val);
        }

        function formatDate(d) {
            if (!d) return '-';
            // Format as DD/MM/YYYY for better readability
            var parts = d.split('T')[0].split('-');
            if (parts.length === 3) {
                return parts[2] + '/' + parts[1] + '/' + parts[0];
            }
            return d.split('T')[0];
        }

        // Build category options HTML with optgroup for Income/Expense
        function buildCategoryOptionsHtml() {
            var incomeCats = categories.filter(function(c) { return c.type === 'Income'; });
            var expenseCats = categories.filter(function(c) { return c.type === 'Expense' || c.type !== 'Income'; });

            var html = '<option value="">Sin categoria</option>';

            if (incomeCats.length > 0) {
                html += '<optgroup label="INGRESOS">';
                incomeCats.forEach(function(c) {
                    html += '<option value="' + c.name + '">' + c.name + '</option>';
                });
                html += '</optgroup>';
            }

            if (expenseCats.length > 0) {
                html += '<optgroup label="GASTOS">';
                expenseCats.forEach(function(c) {
                    html += '<option value="' + c.name + '">' + c.name + '</option>';
                });
                html += '</optgroup>';
            }

            return html;
        }

        // Populate offerings select (Ofertas G4U)
        function populateOfferingsSelect(selectId, selectedValue) {
            var select = document.getElementById(selectId);
            if (!select) return;

            var html = '<option value="">Selecciona una oferta</option>';
            offerings.forEach(function(o) {
                // o.id is the Airtable record ID for linking
                // o.name is the display name
                // o.code is the short code (GTM, Consulting, etc.)
                var displayName = o.name || o.code || o.id;
                var selected = (selectedValue && selectedValue === o.id) ? ' selected' : '';
                html += '<option value="' + o.id + '"' + selected + '>' + displayName + '</option>';
            });
            select.innerHTML = html;
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(function(item) {
            item.addEventListener('click', function() {
                var view = this.getAttribute('data-view');
                if (view) showView(view);
            });
        });

        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var main = document.getElementById('main');
            sidebar.classList.toggle('collapsed');
            main.classList.toggle('expanded');
        }

        function showView(name) {
            document.querySelectorAll('.nav-item').forEach(function(i) { i.classList.remove('active'); });
            document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
            document.querySelector('.nav-item[data-view="'+name+'"]').classList.add('active');
            document.getElementById('view-'+name).classList.add('active');
        }

        // Settings tabs
        function showSettingsTab(name, event) {
            document.querySelectorAll('#view-settings .tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.settings-section').forEach(function(s) { s.classList.add('hidden'); });
            if (event && event.target) event.target.classList.add('active');
            document.getElementById('settings-' + name).classList.remove('hidden');
            // Load tab-specific data
            if (name === 'team') applyColumnVisibility('team');
            if (name === 'clients') applyColumnVisibility('clients');
            if (name === 'projects') applyColumnVisibility('projects');
            if (name === 'offerings') loadOfferings();
            if (name === 'general-expenses') initMonthlyDistribution();
        }

        // ==================== Monthly Distribution ====================
        var monthlyDistributions = {};  // { "2025-01": { "proj_id": 40, ... }, ... }
        var currentDistributionMonth = '';
        var currentMonthData = { distributions: [], general_expenses: 0, active_projects: [] };

        function initMonthlyDistribution() {
            // Populate month selector with last 12 months + next 2 months
            var select = document.getElementById('distribution-month');
            var options = '';
            var today = new Date();

            for (var i = -12; i <= 2; i++) {
                var d = new Date(today.getFullYear(), today.getMonth() + i, 1);
                var yyyy = d.getFullYear();
                var mm = String(d.getMonth() + 1).padStart(2, '0');
                var value = yyyy + '-' + mm;
                var label = d.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                label = label.charAt(0).toUpperCase() + label.slice(1);
                var selected = (i === 0) ? ' selected' : '';
                options += '<option value="' + value + '"' + selected + '>' + label + '</option>';
            }
            select.innerHTML = options;

            // Set current month and load data
            currentDistributionMonth = select.value;
            loadMonthlyDistribution();
        }

        function changeDistributionMonth(delta) {
            var select = document.getElementById('distribution-month');
            var newIdx = select.selectedIndex + delta;
            if (newIdx >= 0 && newIdx < select.options.length) {
                select.selectedIndex = newIdx;
                loadMonthlyDistribution();
            }
        }

        function loadMonthlyDistribution() {
            var month = document.getElementById('distribution-month').value;
            currentDistributionMonth = month;

            // Show loading state
            document.getElementById('monthly-distribution-table').innerHTML =
                '<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--text-muted);">' +
                '<div style="display:flex;align-items:center;justify-content:center;gap:10px;">' +
                '<span style="display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;"></span>' +
                'Actualizando proyectos activos...</div></td></tr>';

            fetch('/api/monthly-distribution?month=' + month)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) {
                    console.error('Error loading distribution:', data.error);
                    document.getElementById('monthly-distribution-table').innerHTML =
                        '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--danger);">Error al cargar datos</td></tr>';
                    return;
                }
                currentMonthData = data;
                renderMonthlyDistribution();
            })
            .catch(function(e) {
                console.error('Error loading monthly distribution:', e);
                document.getElementById('monthly-distribution-table').innerHTML =
                    '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--danger);">Error de conexion</td></tr>';
            });
        }

        function renderMonthlyDistribution() {
            var data = currentMonthData;
            var generalExpenses = data.general_expenses || 0;

            // Update summary
            document.getElementById('month-general-expenses').textContent = fmt(generalExpenses);

            // Build table
            var html = '';
            var totalPct = 0;

            data.distributions.forEach(function(d) {
                var pct = d.percentage || 0;
                totalPct += pct;
                var amount = generalExpenses * pct / 100;

                html += '<tr>';
                html += '<td><strong>' + (d.project_name || '-') + '</strong></td>';
                html += '<td class="text-muted">' + (d.client_name || 'Sin cliente') + '</td>';
                html += '<td style="text-align:right;">';
                html += '<input type="number" min="0" max="100" step="0.1" value="' + pct + '" ';
                html += 'data-project-id="' + d.project_id + '" ';
                html += 'onchange="updateMonthlyDistributionPct(this)" ';
                html += 'style="width:70px;text-align:right;padding:6px 8px;border:1px solid var(--border);border-radius:6px;">';
                html += ' %</td>';
                html += '<td style="text-align:right;">' + fmt(amount) + '</td>';
                html += '</tr>';
            });

            document.getElementById('monthly-distribution-table').innerHTML = html ||
                '<tr><td colspan="4" class="text-muted" style="text-align:center;padding:20px;">No hay proyectos activos</td></tr>';

            updateMonthlyDistributionTotals();
        }

        function updateMonthlyDistributionPct(input) {
            var projectId = input.getAttribute('data-project-id');
            var pct = parseFloat(input.value) || 0;

            // Update in currentMonthData
            var found = currentMonthData.distributions.find(function(d) { return d.project_id === projectId; });
            if (found) {
                found.percentage = pct;
            }

            updateMonthlyDistributionTotals();
        }

        function updateMonthlyDistributionTotals() {
            var totalPct = 0;
            currentMonthData.distributions.forEach(function(d) {
                totalPct += d.percentage || 0;
            });

            var generalExpenses = currentMonthData.general_expenses || 0;
            var distributedAmount = generalExpenses * totalPct / 100;

            document.getElementById('distribution-total-pct').textContent = totalPct.toFixed(1) + '%';
            document.getElementById('distribution-total-amount').textContent = '(' + fmt(distributedAmount) + ')';

            // Update progress bar
            var progressBar = document.getElementById('distribution-progress-bar');
            progressBar.style.width = Math.min(totalPct, 100) + '%';

            if (Math.abs(totalPct - 100) < 0.1) {
                progressBar.style.background = 'var(--success)';
                document.getElementById('distribution-total-pct').style.color = 'var(--success)';
            } else if (totalPct > 100) {
                progressBar.style.background = 'var(--danger)';
                document.getElementById('distribution-total-pct').style.color = 'var(--danger)';
            } else {
                progressBar.style.background = 'var(--warning)';
                document.getElementById('distribution-total-pct').style.color = 'var(--warning)';
            }

            // Update amounts in table
            var rows = document.querySelectorAll('#monthly-distribution-table tr');
            currentMonthData.distributions.forEach(function(d, i) {
                if (rows[i]) {
                    var amountCell = rows[i].querySelector('td:last-child');
                    if (amountCell) {
                        var amount = generalExpenses * (d.percentage || 0) / 100;
                        amountCell.textContent = fmt(amount);
                    }
                }
            });
        }

        function distributeMonthlyEqually() {
            var count = currentMonthData.distributions.length;
            if (count === 0) return;

            var pctEach = Math.round((100 / count) * 10) / 10;
            var remainder = 100 - (pctEach * count);

            currentMonthData.distributions.forEach(function(d, i) {
                d.percentage = pctEach;
                // Add remainder to last project
                if (i === count - 1) {
                    d.percentage = Math.round((d.percentage + remainder) * 10) / 10;
                }
            });

            renderMonthlyDistribution();
        }

        function clearMonthlyDistribution() {
            currentMonthData.distributions.forEach(function(d) {
                d.percentage = 0;
            });
            renderMonthlyDistribution();
        }

        function saveMonthlyDistribution() {
            var distributions = {};
            currentMonthData.distributions.forEach(function(d) {
                if (d.percentage > 0) {
                    distributions[d.project_id] = d.percentage;
                }
            });

            fetch('/api/monthly-distribution', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    month: currentDistributionMonth,
                    distributions: distributions
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.ok) {
                    // Update local cache
                    monthlyDistributions[currentDistributionMonth] = distributions;
                    alert('Distribucion guardada para ' + currentDistributionMonth);
                } else {
                    alert('Error: ' + (result.error || 'No se pudo guardar'));
                }
            })
            .catch(function(e) {
                alert('Error de conexion: ' + e.message);
            });
        }

        function loadAllMonthlyDistributions() {
            fetch('/api/monthly-distribution/all')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.monthly_distributions) {
                    monthlyDistributions = data.monthly_distributions;
                }
            })
            .catch(function(e) {
                console.log('No se pudo cargar distribuciones mensuales');
            });
        }

        // Legacy support - keep old variable for P&L calculations until migration
        var generalExpensesDistribution = {};

        // P&L tabs
        function showPLTab(name, event) {
            document.querySelectorAll('#view-pl .tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.pl-tab-content').forEach(function(s) { s.classList.add('hidden'); });
            if (event && event.target) event.target.classList.add('active');
            document.getElementById('pl-' + name).classList.remove('hidden');
            if (name === 'projects') renderPLProjects();
            if (name === 'clients') renderPLClients();
        }

        // Drilldown: Navigate to transactions filtered by project
        function showProjectTransactions(projectId) {
            showView('transactions');
            // Set the project filter
            var projectFilter = document.getElementById('tx-filter-project');
            if (projectFilter) {
                projectFilter.value = projectId;
            }
            // Clear other filters to show all transactions for this project
            document.getElementById('tx-filter-type').value = '';
            document.getElementById('tx-filter-qonto-cat').value = '';
            document.getElementById('tx-filter-g4u-cat').value = '';
            document.getElementById('tx-filter-client').value = '';
            document.getElementById('tx-filter-assigned').value = '';
            document.getElementById('tx-search').value = '';
            // Apply filters
            renderTransactions();
        }

        // Drilldown: Navigate to transactions filtered by client
        function showClientTransactions(clientId) {
            showView('transactions');
            // Set the client filter
            var clientFilter = document.getElementById('tx-filter-client');
            if (clientFilter) {
                clientFilter.value = clientId;
            }
            // Clear other filters to show all transactions for this client
            document.getElementById('tx-filter-type').value = '';
            document.getElementById('tx-filter-qonto-cat').value = '';
            document.getElementById('tx-filter-g4u-cat').value = '';
            document.getElementById('tx-filter-project').value = '';
            document.getElementById('tx-filter-assigned').value = '';
            document.getElementById('tx-search').value = '';
            // Apply filters
            renderTransactions();
        }

        // Modal
        function openModal(name) {
            document.getElementById('modal-'+name).classList.add('active');
            if (name === 'add-transaction') {
                document.getElementById('new-tx-date').value = new Date().toISOString().split('T')[0];
            }
            // Populate client and offerings selects when opening project modals
            if (name === 'add-project') {
                populateProjectClientSelect();
                populateOfferingsSelect('new-project-service');
            }
            if (name === 'edit-project') {
                populateProjectClientSelect();
                // Note: offerings select for edit is populated in editProject() with selected value
            }
        }
        function closeModal(name) {
            document.getElementById('modal-'+name).classList.remove('active');
        }

        // Data Loading
        function loadData() {
            fetch('/api/data').then(function(r) { return r.json(); }).then(function(data) {
                if (data.error) {
                    console.error(data.error);
                    return;
                }
                transactions = data.transactions || [];
                categories = data.categories || [];
                projects = data.projects || [];

                populateTransactionFilters();
                applyFilters();
                renderAll();

                // Load monthly distributions for P&L calculations
                loadAllMonthlyDistributions();
            }).catch(function(e) {
                console.error('Error loading data:', e);
            });
        }

        function checkStatus() {
            fetch('/api/status').then(function(r) { return r.json(); }).then(function(data) {
                var ok = data.airtable && data.qonto;
                document.getElementById('status-indicator').innerHTML = ok
                    ? '<span class="status ok">Conectado</span>'
                    : '<span class="status error">Desconectado</span>';
                document.getElementById('status-qonto').innerHTML = data.qonto ? '<span class="status ok">OK</span>' : '<span class="status error">Error</span>';
                document.getElementById('status-airtable').innerHTML = data.airtable ? '<span class="status ok">OK</span>' : '<span class="status error">Error</span>';
            });
        }

        // Filtering
        function applyFilters() {
            var period = document.getElementById('filter-period').value;
            var customDates = document.getElementById('custom-dates');

            if (period === 'custom') {
                customDates.classList.remove('hidden');
            } else {
                customDates.classList.add('hidden');
            }

            var now = new Date();
            var from = null, to = null;

            if (period === '30days') {
                from = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                to = now;
            } else if (period === 'month') {
                from = new Date(now.getFullYear(), now.getMonth(), 1);
                to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (period === 'quarter') {
                var q = Math.floor(now.getMonth() / 3);
                from = new Date(now.getFullYear(), q * 3, 1);
                to = new Date(now.getFullYear(), (q + 1) * 3, 0);
            } else if (period === 'year') {
                from = new Date(now.getFullYear(), 0, 1);
                to = new Date(now.getFullYear(), 11, 31);
            } else if (period === 'custom') {
                var fromVal = document.getElementById('filter-from').value;
                var toVal = document.getElementById('filter-to').value;
                if (fromVal) from = new Date(fromVal);
                if (toVal) to = new Date(toVal);
            }

            filteredTransactions = transactions.filter(function(t) {
                if (!t.settled_at) return true;
                var d = new Date(t.settled_at);
                if (from && d < from) return false;
                if (to && d > to) return false;
                return true;
            });

            renderDashboard();
        }

        // Rendering
        function renderAll() {
            renderDashboard();
            renderTransactions();
            renderPL();
        }

        function renderDashboard() {
            renderKPIs();
            renderCharts();
            renderTops();
        }

        function renderKPIs() {
            var income = 0, expenses = 0;
            filteredTransactions.forEach(function(t) {
                var amt = parseFloat(t.amount) || 0;
                if (t.side === 'credit') income += amt;
                else expenses += amt;
            });
            var net = income - expenses;
            var margin = income > 0 ? (net / income * 100) : 0;

            // Update global vars for AI Brain context
            totalIncome = income;
            totalExpenses = expenses;

            // Main KPIs
            document.getElementById('kpi-balance').textContent = fmt(qontoBalance);
            document.getElementById('kpi-balance').className = 'kpi-value ' + (qontoBalance >= 0 ? 'positive' : 'negative');
            document.getElementById('kpi-income').textContent = fmt(income);
            document.getElementById('kpi-expenses').textContent = fmt(expenses);
            document.getElementById('kpi-net').textContent = fmt(net);
            document.getElementById('kpi-net').className = 'kpi-value ' + (net >= 0 ? 'positive' : 'negative');
            document.getElementById('kpi-margin').textContent = margin.toFixed(1) + '%';
            document.getElementById('kpi-margin').className = 'kpi-value ' + (margin >= 0 ? 'positive' : 'negative');

            // Counters
            var activeClients = clients.filter(function(c) { return c.status !== 'Inactivo'; });
            var activeProjects = projects.filter(function(p) { return p.status === 'Active'; });
            document.getElementById('kpi-clients').textContent = activeClients.length;
            document.getElementById('kpi-projects').textContent = activeProjects.length;
            document.getElementById('kpi-transactions').textContent = filteredTransactions.length;
            document.getElementById('kpi-team').textContent = teamMembers.length;
        }

        function renderCharts() {
            var expensesByCategory = {};
            var incomeByCategory = {};

            filteredTransactions.forEach(function(t) {
                var amt = parseFloat(t.amount) || 0;
                var cat = t.qonto_category || 'Sin categoria';
                if (t.side === 'credit') {
                    incomeByCategory[cat] = (incomeByCategory[cat] || 0) + amt;
                } else {
                    expensesByCategory[cat] = (expensesByCategory[cat] || 0) + amt;
                }
            });

            var colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1'];

            // Expenses chart (vertical bar)
            var expLabels = Object.keys(expensesByCategory).sort(function(a,b) { return expensesByCategory[b] - expensesByCategory[a]; }).slice(0,10);
            var expData = expLabels.map(function(k) { return expensesByCategory[k]; });

            if (expensesChart) expensesChart.destroy();
            var expCtx = document.getElementById('chart-expenses');
            if (expCtx && expLabels.length > 0) {
                expensesChart = new Chart(expCtx, {
                    type: 'bar',
                    data: { labels: expLabels, datasets: [{ label: 'Gastos', data: expData, backgroundColor: '#ef4444', borderRadius: 4 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } },
                            y: { ticks: { callback: function(v) { return fmt(v); } }, beginAtZero: true }
                        }
                    }
                });
            }
            document.getElementById('chart-expenses-legend').innerHTML = '';

            // Income chart (vertical bar)
            var incLabels = Object.keys(incomeByCategory).sort(function(a,b) { return incomeByCategory[b] - incomeByCategory[a]; }).slice(0,10);
            var incData = incLabels.map(function(k) { return incomeByCategory[k]; });

            if (incomeChart) incomeChart.destroy();
            var incCtx = document.getElementById('chart-income');
            if (incCtx && incLabels.length > 0) {
                incomeChart = new Chart(incCtx, {
                    type: 'bar',
                    data: { labels: incLabels, datasets: [{ label: 'Ingresos', data: incData, backgroundColor: '#10b981', borderRadius: 4 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } },
                            y: { ticks: { callback: function(v) { return fmt(v); } }, beginAtZero: true }
                        }
                    }
                });
            }
            document.getElementById('chart-income-legend').innerHTML = '';
        }

        function renderTops() {
            // Top expenses - by G4U category, Qonto category, or by counterparty based on view selection
            var expView = document.getElementById('top-expenses-view').value;
            var expByKey = {};
            var expKeyData = {}; // Store metadata for click navigation
            var incByCounterparty = {};

            filteredTransactions.forEach(function(t) {
                var amt = parseFloat(t.amount) || 0;
                if (t.side === 'credit') {
                    var name = t.counterparty_name || 'Otros';
                    incByCounterparty[name] = (incByCounterparty[name] || 0) + amt;
                } else {
                    var key, keyType, keyValue;
                    if (expView === 'g4u_category') {
                        // Categoría G4U - buscar desde allocations primero, luego campo directo
                        var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });
                        var allocCat = txAllocs.length > 0 ? txAllocs[0].category : null;
                        var catName = allocCat || t.category || t.category_id || '';
                        // Si es un ID, buscar el nombre
                        var cat = categories.find(function(c) { return c.id === catName || c.name === catName; });
                        key = cat ? cat.name : (catName || 'Sin Categoría G4U');
                        keyType = 'category';
                        keyValue = cat ? cat.id : catName;
                    } else if (expView === 'qonto_category') {
                        // Categoría Qonto
                        key = t.qonto_category || 'Sin categoria Qonto';
                        keyType = 'qonto_category';
                        keyValue = t.qonto_category || '';
                    } else {
                        // Transaction (counterparty)
                        key = t.counterparty_name || 'Otros';
                        keyType = 'counterparty';
                        keyValue = t.counterparty_name || '';
                    }
                    expByKey[key] = (expByKey[key] || 0) + amt;
                    expKeyData[key] = { type: keyType, value: keyValue };
                }
            });

            var topExp = Object.keys(expByKey).sort(function(a,b) { return expByKey[b] - expByKey[a]; }).slice(0,5);
            var topExpHtml = topExp.map(function(name) {
                var data = expKeyData[name] || {};
                var onclick = 'navigateToTransactionsWithFilter(\'' + data.type + '\', \'' + (data.value || '').replace(/'/g, "\\'") + '\', \'debit\')';
                return '<div class="top-item clickable" onclick="' + onclick + '" style="cursor:pointer;"><span class="top-item-name">' + name + '</span><span class="top-item-amount negative">' + fmt(expByKey[name]) + '</span></div>';
            }).join('') || '<div class="text-muted" style="padding:20px;text-align:center;">Sin datos</div>';
            document.getElementById('top-expenses').innerHTML = topExpHtml;

            // Top Ingresos - by counterparty, clickable
            var topInc = Object.keys(incByCounterparty).sort(function(a,b) { return incByCounterparty[b] - incByCounterparty[a]; }).slice(0,5);
            var topIncHtml = topInc.map(function(name) {
                var onclick = 'navigateToTransactionsWithFilter(\'counterparty\', \'' + name.replace(/'/g, "\\'") + '\', \'credit\')';
                return '<div class="top-item clickable" onclick="' + onclick + '" style="cursor:pointer;"><span class="top-item-name">' + name + '</span><span class="top-item-amount positive">' + fmt(incByCounterparty[name]) + '</span></div>';
            }).join('') || '<div class="text-muted" style="padding:20px;text-align:center;">Sin datos</div>';
            document.getElementById('top-income').innerHTML = topIncHtml;

            // Top clients (by transaction allocations), clickable
            var clientTotals = {};
            clients.forEach(function(c) { clientTotals[c.id] = { id: c.id, name: c.name, income: 0 }; });
            transactionAllocations.forEach(function(a) {
                if (a.client_id && clientTotals[a.client_id]) {
                    var tx = transactions.find(function(t) { return t.id === a.transaction_id; });
                    if (tx && tx.side === 'credit') {
                        clientTotals[a.client_id].income += (parseFloat(tx.amount) || 0) * a.percentage / 100;
                    }
                }
            });
            var topClients = Object.values(clientTotals).filter(function(c) { return c.income > 0; }).sort(function(a,b) { return b.income - a.income; }).slice(0,5);
            var topClientsHtml = topClients.map(function(c) {
                var onclick = 'navigateToTransactionsWithFilter(\'client\', \'' + c.id + '\')';
                return '<div class="top-item clickable" onclick="' + onclick + '" style="cursor:pointer;"><span class="top-item-name">' + c.name + '</span><span class="top-item-amount positive">' + fmt(c.income) + '</span></div>';
            }).join('') || '<div class="text-muted" style="padding:20px;text-align:center;">Sin datos</div>';
            document.getElementById('top-clients').innerHTML = topClientsHtml;

            // Top projects, clickable
            var projectTotals = {};
            projects.forEach(function(p) { projectTotals[p.id] = { id: p.id, name: p.name, income: 0 }; });
            transactionAllocations.forEach(function(a) {
                if (a.project_id && projectTotals[a.project_id]) {
                    var tx = transactions.find(function(t) { return t.id === a.transaction_id; });
                    if (tx && tx.side === 'credit') {
                        projectTotals[a.project_id].income += (parseFloat(tx.amount) || 0) * a.percentage / 100;
                    }
                }
            });
            var topProjects = Object.values(projectTotals).filter(function(p) { return p.income > 0; }).sort(function(a,b) { return b.income - a.income; }).slice(0,5);
            var topProjectsHtml = topProjects.map(function(p) {
                var onclick = 'navigateToTransactionsWithFilter(\'project\', \'' + p.id + '\')';
                return '<div class="top-item clickable" onclick="' + onclick + '" style="cursor:pointer;"><span class="top-item-name">' + p.name + '</span><span class="top-item-amount positive">' + fmt(p.income) + '</span></div>';
            }).join('') || '<div class="text-muted" style="padding:20px;text-align:center;">Sin datos</div>';
            document.getElementById('top-projects').innerHTML = topProjectsHtml;
        }

        // Navigate to transactions view with specific filter
        function navigateToTransactionsWithFilter(filterType, filterValue, side) {
            // Clear all filters first
            document.getElementById('tx-filter-type').value = side || '';
            document.getElementById('tx-filter-qonto-cat').value = '';
            document.getElementById('tx-filter-g4u-cat').value = '';
            document.getElementById('tx-filter-project').value = '';
            document.getElementById('tx-filter-client').value = '';
            document.getElementById('tx-filter-assigned').value = '';
            document.getElementById('tx-search').value = '';

            // Apply the specific filter
            if (filterType === 'category') {
                // G4U Category - use the new filter
                document.getElementById('tx-filter-g4u-cat').value = filterValue;
            } else if (filterType === 'qonto_category') {
                document.getElementById('tx-filter-qonto-cat').value = filterValue;
            } else if (filterType === 'counterparty') {
                document.getElementById('tx-search').value = filterValue;
            } else if (filterType === 'client') {
                document.getElementById('tx-filter-client').value = filterValue;
            } else if (filterType === 'project') {
                document.getElementById('tx-filter-project').value = filterValue;
            }

            // Navigate to transactions view
            showView('transactions');
            applyFilters();
        }

        function sortTransactions(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'desc';
            }
            // Update sort indicators
            ['settled_at', 'counterparty_name', 'side', 'qonto_category', 'category', 'project', 'client', 'vat_amount', 'amount', 'assigned'].forEach(function(f) {
                var el = document.getElementById('sort-' + f);
                if (el) el.textContent = (f === sortField) ? (sortDirection === 'asc' ? '▲' : '▼') : '';
            });
            renderTransactions();
        }

        function populateTransactionFilters() {
            // Populate Qonto category filter (unique values from transactions)
            var qontoCats = {};
            transactions.forEach(function(t) {
                if (t.qonto_category) qontoCats[t.qonto_category] = true;
            });
            var qontoCatFilter = document.getElementById('tx-filter-qonto-cat');
            var qontoCatHtml = '<option value="">Todas</option>';
            Object.keys(qontoCats).sort().forEach(function(cat) {
                qontoCatHtml += '<option value="' + cat + '">' + cat + '</option>';
            });
            qontoCatFilter.innerHTML = qontoCatHtml;

            // Populate G4U category filter (from categories list)
            var g4uCatFilter = document.getElementById('tx-filter-g4u-cat');
            var g4uCatHtml = '<option value="">Todas</option>';
            categories.forEach(function(cat) {
                g4uCatHtml += '<option value="' + cat.id + '">' + cat.name + '</option>';
            });
            g4uCatFilter.innerHTML = g4uCatHtml;

            // Populate project filter
            var projFilter = document.getElementById('tx-filter-project');
            var projHtml = '<option value="">Todos</option>';
            projects.forEach(function(p) {
                projHtml += '<option value="' + p.id + '">' + p.name + '</option>';
            });
            projFilter.innerHTML = projHtml;

            // Populate client filter
            var clientFilter = document.getElementById('tx-filter-client');
            var clientHtml = '<option value="">Todos</option>';
            clients.forEach(function(c) {
                clientHtml += '<option value="' + c.id + '">' + c.name + '</option>';
            });
            clientFilter.innerHTML = clientHtml;
        }

        function renderTransactions() {
            var filterType = document.getElementById('tx-filter-type').value;
            var filterQontoCat = document.getElementById('tx-filter-qonto-cat').value;
            var filterG4uCat = document.getElementById('tx-filter-g4u-cat').value;
            var filterProject = document.getElementById('tx-filter-project').value;
            var filterClient = document.getElementById('tx-filter-client').value;
            var filterAssigned = document.getElementById('tx-filter-assigned').value;
            var filterFrom = document.getElementById('tx-filter-from').value;
            var filterTo = document.getElementById('tx-filter-to').value;
            var search = (document.getElementById('tx-search').value || '').toLowerCase();

            var filtered = transactions.filter(function(t) {
                // Type filter
                if (filterType && t.side !== filterType) return false;
                // Qonto category filter
                if (filterQontoCat && t.qonto_category !== filterQontoCat) return false;
                // G4U category filter
                if (filterG4uCat && t.category_id !== filterG4uCat) return false;
                // Date range filter
                if (filterFrom && t.settled_at < filterFrom) return false;
                if (filterTo && t.settled_at > filterTo) return false;

                // Get allocations for this transaction
                var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });
                var totalPct = txAllocs.reduce(function(sum, a) { return sum + a.percentage; }, 0);

                // Project filter (based on allocations)
                if (filterProject) {
                    var hasProject = txAllocs.some(function(a) { return a.project_id === filterProject; });
                    if (!hasProject) return false;
                }
                // Client filter (based on allocations)
                if (filterClient) {
                    var hasClient = txAllocs.some(function(a) { return a.client_id === filterClient; });
                    if (!hasClient) return false;
                }
                // Assignment status filter
                if (filterAssigned === 'assigned' && totalPct < 100) return false;
                if (filterAssigned === 'unassigned' && totalPct > 0) return false;
                if (filterAssigned === 'partial') {
                    // Parcialmente asignada = tiene ALGUNO pero NO TODOS:
                    // 1. Tiene allocations pero < 100%
                    // 2. O tiene allocations pero alguna sin categoria/proyecto/cliente
                    var hasIncompleteAlloc = txAllocs.some(function(a) {
                        return !a.category || !a.project_id || !a.client_id;
                    });
                    var isPartialByPct = totalPct > 0 && totalPct < 100;
                    var isPartialByFields = totalPct > 0 && hasIncompleteAlloc;
                    if (!isPartialByPct && !isPartialByFields) return false;
                }
                if (filterAssigned === 'no_category') {
                    // Sin categoria = sin allocations o todas las allocations sin categoria
                    var hasCategory = txAllocs.some(function(a) { return a.category; });
                    if (hasCategory) return false;
                }
                if (filterAssigned === 'no_project') {
                    // Sin proyecto = sin allocations o todas las allocations sin proyecto
                    var hasProject = txAllocs.some(function(a) { return a.project_id; });
                    if (hasProject) return false;
                }
                if (filterAssigned === 'no_client') {
                    // Sin cliente = sin allocations o todas las allocations sin cliente
                    var hasClient = txAllocs.some(function(a) { return a.client_id; });
                    if (hasClient) return false;
                }
                if (filterAssigned === 'excluded') {
                    if (!t.is_excluded) return false;
                }
                if (filterAssigned === 'not_excluded') {
                    if (t.is_excluded) return false;
                }
                if (filterAssigned === 'refund') {
                    if (t.status !== 'reversed') return false;
                }

                // Search filter
                if (search && search.length > 0) {
                    var qontoCat = t.qonto_category || '';
                    var description = t.label || t.counterparty_name || '';
                    var allocInfo = txAllocs.map(function(a) {
                        var parts = [];
                        if (a.category) parts.push(a.category);
                        if (a.project_id) {
                            var p = projects.find(function(proj) { return proj.id === a.project_id; });
                            if (p) parts.push(p.name);
                        }
                        if (a.client_id) {
                            var c = clients.find(function(cli) { return cli.id === a.client_id; });
                            if (c) parts.push(c.name);
                        }
                        return parts.join(' ');
                    }).join(' ');
                    var searchText = [
                        t.counterparty_name || '',
                        t.label || '',
                        description,
                        qontoCat,
                        allocInfo
                    ].join(' ').toLowerCase();
                    if (searchText.indexOf(search) === -1) return false;
                }
                return true;
            });

            // Add computed fields for sorting
            filtered.forEach(function(t) {
                var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });
                t._category = '-';
                t._project = '-';
                t._client = '-';
                t._allocPct = 0;
                if (txAllocs.length > 0) {
                    t._allocPct = Math.round(txAllocs.reduce(function(sum, a) { return sum + (a.percentage || 0); }, 0));

                    // Category: show unique category (should be same for all allocations)
                    var cats = txAllocs.map(function(a) { return a.category; }).filter(Boolean);
                    var uniqueCats = cats.filter(function(c, i, arr) { return arr.indexOf(c) === i; });
                    if (uniqueCats.length === 1) {
                        t._category = uniqueCats[0];
                    } else if (uniqueCats.length > 1) {
                        t._category = uniqueCats[0]; // Show first one (should be same)
                    }

                    // Projects: show "Multiples" if >1, otherwise show name
                    var projNames = txAllocs.map(function(a) {
                        if (a.project_id) {
                            var p = projects.find(function(p) { return p.id === a.project_id; });
                            return p ? p.name : null;
                        }
                        return null;
                    }).filter(Boolean);
                    var uniqueProjects = projNames.filter(function(p, i, arr) { return arr.indexOf(p) === i; });
                    if (uniqueProjects.length === 1) {
                        t._project = uniqueProjects[0];
                    } else if (uniqueProjects.length > 1) {
                        t._project = 'Multiples (' + uniqueProjects.length + ')';
                    }

                    // Clients: show "Multiples" if >1, otherwise show name
                    var clientNames = txAllocs.map(function(a) {
                        if (a.client_id) {
                            var c = clients.find(function(c) { return c.id === a.client_id; });
                            return c ? c.name : null;
                        }
                        return null;
                    }).filter(Boolean);
                    var uniqueClients = clientNames.filter(function(c, i, arr) { return arr.indexOf(c) === i; });
                    if (uniqueClients.length === 1) {
                        t._client = uniqueClients[0];
                    } else if (uniqueClients.length > 1) {
                        t._client = 'Multiples (' + uniqueClients.length + ')';
                    }
                }
            });

            // Sort transactions
            filtered.sort(function(a, b) {
                var aVal, bVal;
                if (sortField === 'category') {
                    aVal = a._category || '';
                    bVal = b._category || '';
                } else if (sortField === 'project') {
                    aVal = a._project || '';
                    bVal = b._project || '';
                } else if (sortField === 'client') {
                    aVal = a._client || '';
                    bVal = b._client || '';
                } else if (sortField === 'assigned') {
                    aVal = a._allocPct || 0;
                    bVal = b._allocPct || 0;
                } else {
                    aVal = a[sortField] || '';
                    bVal = b[sortField] || '';
                }
                if (sortField === 'amount' || sortField === 'vat_amount' || sortField === 'assigned') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            var html = '';
            filtered.forEach(function(t) {
                var cls = t.side === 'credit' ? 'positive' : 'negative';
                var sign = t.side === 'credit' ? '+' : '-';
                var typeLabel = t.side === 'credit' ? 'Ingreso' : 'Gasto';
                var typeCls = t.side === 'credit' ? 'ingreso' : 'gasto';
                var vatAmount = parseFloat(t.vat_amount) || 0;
                var category = t._category;
                var projectName = t._project;
                var clientName = t._client;
                var isSelected = selectedTransactions.indexOf(t.id) !== -1;
                var allocPct = t._allocPct || 0;
                var allocColor = allocPct >= 100 ? '#10b981' : (allocPct > 0 ? '#f59e0b' : '#94a3b8');
                var allocBg = allocPct >= 100 ? '#dcfce7' : (allocPct > 0 ? '#fef3c7' : '#f1f5f9');
                var isExcluded = t.is_excluded || false;
                var isRefund = t.status === 'reversed';
                var rowClasses = [];
                if (isExcluded) rowClasses.push('excluded');
                if (isRefund) rowClasses.push('refund');
                var rowStyle = isSelected ? ' style="background:#e0f2fe;"' : '';

                // Build badges
                var badges = '';
                if (isRefund) badges += '<span class="badge-refund">Devolucion</span>';
                if (isExcluded) badges += '<span class="badge-excluded">Excluida</span>';

                html += '<tr class="' + rowClasses.join(' ') + '"' + rowStyle + '>';
                html += '<td><input type="checkbox" class="tx-checkbox" data-id="' + t.id + '" onchange="toggleTxSelection(\'' + t.id + '\')"' + (isSelected ? ' checked' : '') + '></td>';
                html += '<td style="white-space:nowrap;">' + formatDate(t.settled_at) + '</td>';
                html += '<td>' + (t.counterparty_name || t.label || '-') + badges + '</td>';
                html += '<td><span class="type-badge ' + typeCls + '">' + typeLabel + '</span></td>';
                html += '<td style="font-size:12px;color:#666;">' + (t.qonto_category || '-') + '</td>';
                html += '<td style="font-size:12px;">' + category + '</td>';
                html += '<td style="font-size:12px;">' + projectName + '</td>';
                html += '<td style="font-size:12px;">' + clientName + '</td>';
                html += '<td style="text-align:right;font-size:12px;">' + (vatAmount > 0 ? fmt(vatAmount) : '-') + '</td>';
                html += '<td style="text-align:right" class="amount ' + cls + '">' + sign + fmt(t.amount) + '</td>';
                html += '<td style="text-align:center;"><span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;background:' + allocBg + ';color:' + allocColor + ';">' + allocPct + '%</span></td>';
                html += '<td style="display:flex;gap:4px;">';
                html += '<button onclick="openTxAllocation(\'' + t.id + '\')" class="btn btn-sm btn-outline" style="padding:2px 6px;font-size:10px;">Asignar</button>';
                html += '<button onclick="toggleExcludeTransaction(\'' + t.id + '\', ' + !isExcluded + ')" class="btn-exclude' + (isExcluded ? ' active' : '') + '" title="' + (isExcluded ? 'Incluir en reportes' : 'Excluir de reportes') + '">' + (isExcluded ? 'Incluir' : 'Excluir') + '</button>';
                html += '</td>';
                html += '</tr>';
            });
            document.getElementById('transactions-table').innerHTML = html || '<tr><td colspan="12" class="text-muted" style="text-align:center;padding:40px;">No hay transacciones</td></tr>';
        }

        function calcPLData(txList, excludeVat) {
            var income = 0, expenses = 0;
            var totalVat = 0;
            var byCategory = {};

            // Check if excludeVat is enabled (default to checkbox state if not provided)
            if (excludeVat === undefined) {
                var vatCheckbox = document.getElementById('pl-exclude-vat');
                excludeVat = vatCheckbox ? vatCheckbox.checked : false;
            }

            txList.forEach(function(t) {
                // Skip excluded transactions
                if (t.is_excluded) return;

                var amt = parseFloat(t.amount) || 0;
                var vatAmt = parseFloat(t.vat_amount) || 0;

                // If excluding VAT, subtract the VAT amount
                if (excludeVat && vatAmt > 0) {
                    amt = amt - vatAmt;
                    totalVat += vatAmt;
                }

                var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });

                if (txAllocs.length > 0) {
                    var totalAllocPct = 0;
                    txAllocs.forEach(function(alloc) {
                        var allocAmt = amt * alloc.percentage / 100;
                        totalAllocPct += alloc.percentage;
                        var cat = alloc.category || 'Sin categoria';
                        if (!byCategory[cat]) byCategory[cat] = {income: 0, expense: 0};
                        if (t.side === 'credit') {
                            income += allocAmt;
                            byCategory[cat].income += allocAmt;
                        } else {
                            expenses += allocAmt;
                            byCategory[cat].expense += allocAmt;
                        }
                    });
                    // If allocations don't sum to 100%, add remainder to "Sin categoria"
                    if (totalAllocPct < 100) {
                        var remainderAmt = amt * (100 - totalAllocPct) / 100;
                        var cat = 'Sin categoria';
                        if (!byCategory[cat]) byCategory[cat] = {income: 0, expense: 0};
                        if (t.side === 'credit') {
                            income += remainderAmt;
                            byCategory[cat].income += remainderAmt;
                        } else {
                            expenses += remainderAmt;
                            byCategory[cat].expense += remainderAmt;
                        }
                    }
                } else {
                    var cat = 'Sin categoria';
                    if (!byCategory[cat]) byCategory[cat] = {income: 0, expense: 0};
                    if (t.side === 'credit') {
                        income += amt;
                        byCategory[cat].income += amt;
                    } else {
                        expenses += amt;
                        byCategory[cat].expense += amt;
                    }
                }
            });

            return { income: income, expenses: expenses, byCategory: byCategory, net: income - expenses, totalVat: totalVat };
        }

        function formatChange(current, previous) {
            if (previous === 0) return '';
            var pct = ((current - previous) / Math.abs(previous)) * 100;
            var arrow = pct >= 0 ? '↑' : '↓';
            var color = pct >= 0 ? '#10b981' : '#ef4444';
            return '<span style="font-size:11px;color:' + color + ';margin-left:8px;">' + arrow + Math.abs(pct).toFixed(1) + '%</span>';
        }

        function renderPL() {
            var isComparative = document.getElementById('pl-comparative').checked;
            var currentDates = getPLPeriodDates();
            var plTx = getPLFilteredTransactions();
            var current = calcPLData(plTx);

            var prev = null;
            if (isComparative && currentDates.from && currentDates.to) {
                var prevDates = getPreviousPeriodDates(currentDates);
                var prevTx = filterTransactionsByDates(prevDates.from, prevDates.to);
                prev = calcPLData(prevTx);
            }

            var html = '';

            // Header for comparative mode
            if (prev) {
                html += '<div class="pl-section" style="background:#f8fafc;padding:8px 16px;border-radius:6px;margin-bottom:12px;">';
                html += '<div style="display:grid;grid-template-columns:1fr 120px 120px 80px;gap:8px;font-size:12px;font-weight:600;color:var(--text-muted);">';
                html += '<span></span><span style="text-align:right;">Actual</span><span style="text-align:right;">Anterior</span><span style="text-align:right;">Var.</span>';
                html += '</div></div>';
            }

            // Revenue Section
            html += '<div class="pl-section">';
            html += '<div class="pl-section-header"><span>INGRESOS</span><span></span></div>';
            var allCats = Object.keys(current.byCategory);
            if (prev) {
                Object.keys(prev.byCategory).forEach(function(c) { if (allCats.indexOf(c) === -1) allCats.push(c); });
            }
            allCats.forEach(function(cat) {
                var curInc = current.byCategory[cat] ? current.byCategory[cat].income : 0;
                var prevInc = prev && prev.byCategory[cat] ? prev.byCategory[cat].income : 0;
                if (curInc > 0 || prevInc > 0) {
                    if (prev) {
                        var chg = prevInc ? (((curInc - prevInc) / Math.abs(prevInc)) * 100).toFixed(1) : '-';
                        var chgColor = curInc >= prevInc ? '#10b981' : '#ef4444';
                        html += '<div class="pl-row indent" style="display:grid;grid-template-columns:1fr 120px 120px 80px;gap:8px;">';
                        html += '<span class="pl-label">' + cat + '</span>';
                        html += '<span class="pl-amount positive" style="text-align:right;">' + fmt(curInc) + '</span>';
                        html += '<span class="pl-amount" style="text-align:right;color:var(--text-muted);">' + fmt(prevInc) + '</span>';
                        html += '<span style="text-align:right;font-size:12px;color:' + chgColor + ';">' + (chg !== '-' ? chg + '%' : '-') + '</span>';
                        html += '</div>';
                    } else {
                        html += '<div class="pl-row indent"><span class="pl-label">' + cat + '</span><span class="pl-amount positive">' + fmt(curInc) + '</span></div>';
                    }
                }
            });
            if (prev) {
                var incChg = prev.income ? (((current.income - prev.income) / Math.abs(prev.income)) * 100).toFixed(1) : '-';
                var incColor = current.income >= prev.income ? '#10b981' : '#ef4444';
                html += '<div class="pl-row total" style="display:grid;grid-template-columns:1fr 120px 120px 80px;gap:8px;">';
                html += '<span>Total Ingresos</span>';
                html += '<span class="pl-amount positive" style="text-align:right;">' + fmt(current.income) + '</span>';
                html += '<span class="pl-amount" style="text-align:right;color:var(--text-muted);">' + fmt(prev.income) + '</span>';
                html += '<span style="text-align:right;font-weight:600;color:' + incColor + ';">' + (incChg !== '-' ? incChg + '%' : '-') + '</span>';
                html += '</div>';
            } else {
                html += '<div class="pl-row total"><span>Total Ingresos</span><span class="pl-amount positive">' + fmt(current.income) + '</span></div>';
            }
            html += '</div>';

            // Expenses Section
            html += '<div class="pl-section">';
            html += '<div class="pl-section-header"><span>GASTOS</span><span></span></div>';
            allCats.forEach(function(cat) {
                var curExp = current.byCategory[cat] ? current.byCategory[cat].expense : 0;
                var prevExp = prev && prev.byCategory[cat] ? prev.byCategory[cat].expense : 0;
                if (curExp > 0 || prevExp > 0) {
                    if (prev) {
                        var chg = prevExp ? (((curExp - prevExp) / Math.abs(prevExp)) * 100).toFixed(1) : '-';
                        var chgColor = curExp <= prevExp ? '#10b981' : '#ef4444';
                        html += '<div class="pl-row indent" style="display:grid;grid-template-columns:1fr 120px 120px 80px;gap:8px;">';
                        html += '<span class="pl-label">' + cat + '</span>';
                        html += '<span class="pl-amount negative" style="text-align:right;">' + fmt(curExp) + '</span>';
                        html += '<span class="pl-amount" style="text-align:right;color:var(--text-muted);">' + fmt(prevExp) + '</span>';
                        html += '<span style="text-align:right;font-size:12px;color:' + chgColor + ';">' + (chg !== '-' ? chg + '%' : '-') + '</span>';
                        html += '</div>';
                    } else {
                        html += '<div class="pl-row indent"><span class="pl-label">' + cat + '</span><span class="pl-amount negative">' + fmt(curExp) + '</span></div>';
                    }
                }
            });
            if (prev) {
                var expChg = prev.expenses ? (((current.expenses - prev.expenses) / Math.abs(prev.expenses)) * 100).toFixed(1) : '-';
                var expColor = current.expenses <= prev.expenses ? '#10b981' : '#ef4444';
                html += '<div class="pl-row total" style="display:grid;grid-template-columns:1fr 120px 120px 80px;gap:8px;">';
                html += '<span>Total Gastos</span>';
                html += '<span class="pl-amount negative" style="text-align:right;">' + fmt(current.expenses) + '</span>';
                html += '<span class="pl-amount" style="text-align:right;color:var(--text-muted);">' + fmt(prev.expenses) + '</span>';
                html += '<span style="text-align:right;font-weight:600;color:' + expColor + ';">' + (expChg !== '-' ? expChg + '%' : '-') + '</span>';
                html += '</div>';
            } else {
                html += '<div class="pl-row total"><span>Total Gastos</span><span class="pl-amount negative">' + fmt(current.expenses) + '</span></div>';
            }
            html += '</div>';

            // Net Result
            var netCls = current.net >= 0 ? 'positive' : 'negative';
            html += '<div class="pl-section">';
            if (prev) {
                var netChg = prev.net !== 0 ? (((current.net - prev.net) / Math.abs(prev.net)) * 100).toFixed(1) : '-';
                var netColor = current.net >= prev.net ? '#10b981' : '#ef4444';
                html += '<div class="pl-row grand-total" style="display:grid;grid-template-columns:1fr 120px 120px 80px;gap:8px;">';
                html += '<span>RESULTADO NETO</span>';
                html += '<span class="pl-amount ' + netCls + '" style="text-align:right;">' + fmt(current.net) + '</span>';
                var prevNetCls = prev.net >= 0 ? 'positive' : 'negative';
                html += '<span class="pl-amount" style="text-align:right;color:var(--text-muted);">' + fmt(prev.net) + '</span>';
                html += '<span style="text-align:right;font-weight:600;color:' + netColor + ';">' + (netChg !== '-' ? netChg + '%' : '-') + '</span>';
                html += '</div>';
            } else {
                html += '<div class="pl-row grand-total"><span>RESULTADO NETO</span><span class="pl-amount ' + netCls + '">' + fmt(current.net) + '</span></div>';
            }
            html += '</div>';

            document.getElementById('pl-statement').innerHTML = html;
        }

        function updatePLDateRange() {
            var period = document.getElementById('pl-period').value;
            var customDates = document.getElementById('pl-custom-dates');

            if (period === 'custom') {
                customDates.classList.remove('hidden');
                customDates.style.display = 'flex';
            } else {
                customDates.classList.add('hidden');
                customDates.style.display = 'none';
            }
        }

        function getPLPeriodDates() {
            var period = document.getElementById('pl-period').value;
            var now = new Date();
            var from = null, to = null;

            if (period === 'month') {
                from = new Date(now.getFullYear(), now.getMonth(), 1);
                to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else if (period === 'quarter') {
                var q = Math.floor(now.getMonth() / 3);
                from = new Date(now.getFullYear(), q * 3, 1);
                to = new Date(now.getFullYear(), (q + 1) * 3, 0);
            } else if (period === 'year') {
                from = new Date(now.getFullYear(), 0, 1);
                to = new Date(now.getFullYear(), 11, 31);
            } else if (period === 'custom') {
                var fromVal = document.getElementById('pl-date-from').value;
                var toVal = document.getElementById('pl-date-to').value;
                if (fromVal) from = new Date(fromVal);
                if (toVal) to = new Date(toVal);
            }
            return { from: from, to: to };
        }

        function getPreviousPeriodDates(current) {
            if (!current.from || !current.to) return { from: null, to: null };
            var duration = current.to.getTime() - current.from.getTime();
            var prevTo = new Date(current.from.getTime() - 1); // Day before current period
            var prevFrom = new Date(prevTo.getTime() - duration);
            return { from: prevFrom, to: prevTo };
        }

        function filterTransactionsByDates(from, to) {
            return transactions.filter(function(t) {
                if (!t.settled_at) return true;
                var d = new Date(t.settled_at);
                if (from && d < from) return false;
                if (to && d > to) return false;
                return true;
            });
        }

        function getPLFilteredTransactions() {
            var dates = getPLPeriodDates();
            return filterTransactionsByDates(dates.from, dates.to);
        }

        function getDateRangeFromFilter() {
            var dates = getPLPeriodDates();
            return { start: dates.from, end: dates.to };
        }

        function exportPL(format) {
            var plTx = getPLFilteredTransactions();
            var income = 0, expenses = 0;
            var byCategory = {};

            plTx.forEach(function(t) {
                var amt = parseFloat(t.amount) || 0;
                var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });

                if (txAllocs.length > 0) {
                    txAllocs.forEach(function(alloc) {
                        var allocAmt = amt * alloc.percentage / 100;
                        var cat = alloc.category || 'Sin categoria';
                        if (!byCategory[cat]) byCategory[cat] = {income: 0, expense: 0};
                        if (t.side === 'credit') {
                            income += allocAmt;
                            byCategory[cat].income += allocAmt;
                        } else {
                            expenses += allocAmt;
                            byCategory[cat].expense += allocAmt;
                        }
                    });
                } else {
                    var cat = 'Sin categoria';
                    if (!byCategory[cat]) byCategory[cat] = {income: 0, expense: 0};
                    if (t.side === 'credit') {
                        income += amt;
                        byCategory[cat].income += amt;
                    } else {
                        expenses += amt;
                        byCategory[cat].expense += amt;
                    }
                }
            });

            var rows = [];
            rows.push(['Categoria', 'Ingresos', 'Gastos', 'Neto']);

            Object.keys(byCategory).sort().forEach(function(cat) {
                var d = byCategory[cat];
                rows.push([cat, Math.round(d.income), Math.round(d.expense), Math.round(d.income - d.expense)]);
            });

            rows.push(['']);
            rows.push(['TOTAL', Math.round(income), Math.round(expenses), Math.round(income - expenses)]);

            if (format === 'csv') {
                var csv = rows.map(function(r) { return r.join(','); }).join('\n');
                downloadFile(csv, 'estado-resultados.csv', 'text/csv');
            } else if (format === 'excel') {
                // Excel-compatible format with tabs
                var tsv = rows.map(function(r) { return r.join('\t'); }).join('\n');
                downloadFile(tsv, 'estado-resultados.xls', 'application/vnd.ms-excel');
            }
        }

        function downloadFile(content, filename, mimeType) {
            var blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderPLProjects() {
            var byProject = {};
            var byClient = {};
            var totalIncome = 0;

            // Check if VAT should be excluded
            var excludeVat = document.getElementById('pl-exclude-vat') ? document.getElementById('pl-exclude-vat').checked : false;

            projects.forEach(function(p) {
                byProject[p.id] = {name: p.name, income: 0, expense: 0};
            });
            clients.forEach(function(c) {
                byClient[c.id] = {name: c.name, income: 0, expense: 0};
            });

            // Also add "Sin proyecto" for unassigned
            byProject['_none'] = {name: 'Sin asignar', income: 0, expense: 0};
            byClient['_none'] = {name: 'Sin cliente', income: 0, expense: 0};

            // Add transaction costs using transaction allocations
            var plTx = getPLFilteredTransactions();
            plTx.forEach(function(t) {
                // Skip excluded transactions
                if (t.is_excluded) return;

                var amt = parseFloat(t.amount) || 0;
                var vatAmt = parseFloat(t.vat_amount) || 0;

                // Subtract VAT if checkbox is checked
                if (excludeVat && vatAmt > 0) {
                    amt = amt - vatAmt;
                }

                // Check if transaction has specific allocations
                var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });

                if (txAllocs.length > 0) {
                    // Distribute according to allocations
                    var totalAllocPct = 0;
                    txAllocs.forEach(function(alloc) {
                        var allocAmt = amt * alloc.percentage / 100;
                        totalAllocPct += alloc.percentage;
                        var pid = alloc.project_id || '_none';
                        var cid = alloc.client_id || '_none';

                        if (byProject[pid]) {
                            if (t.side === 'credit') {
                                byProject[pid].income += allocAmt;
                            } else {
                                byProject[pid].expense += allocAmt;
                            }
                        }
                        if (byClient[cid]) {
                            if (t.side === 'credit') {
                                byClient[cid].income += allocAmt;
                            } else {
                                byClient[cid].expense += allocAmt;
                            }
                        }
                    });
                    // If allocations don't sum to 100%, assign remainder to "Sin asignar"
                    if (totalAllocPct < 100) {
                        var remainderAmt = amt * (100 - totalAllocPct) / 100;
                        if (byProject['_none']) {
                            if (t.side === 'credit') {
                                byProject['_none'].income += remainderAmt;
                            } else {
                                byProject['_none'].expense += remainderAmt;
                            }
                        }
                        if (byClient['_none']) {
                            if (t.side === 'credit') {
                                byClient['_none'].income += remainderAmt;
                            } else {
                                byClient['_none'].expense += remainderAmt;
                            }
                        }
                    }
                } else {
                    // No allocations - goes to "Sin asignar"
                    if (byProject['_none']) {
                        if (t.side === 'credit') {
                            byProject['_none'].income += amt;
                        } else {
                            byProject['_none'].expense += amt;
                        }
                    }
                    if (byClient['_none']) {
                        if (t.side === 'credit') {
                            byClient['_none'].income += amt;
                        } else {
                            byClient['_none'].expense += amt;
                        }
                    }
                }

                if (t.side === 'credit') totalIncome += amt;
            });

            // ==================== Monthly Distribution of General Expenses ====================
            // Find "General" project (bucket for distributable expenses)
            var generalProjectId = null;
            projects.forEach(function(p) {
                if (p.name && p.name.toLowerCase() === 'general') {
                    generalProjectId = p.id;
                }
            });

            // Distribute "General" project expenses to other projects based on monthly configuration
            if (generalProjectId && byProject[generalProjectId] && Object.keys(monthlyDistributions).length > 0) {
                // Group "General" project expenses by month
                var generalExpensesByMonth = {};
                plTx.forEach(function(t) {
                    if (t.is_excluded) return;
                    if (t.side !== 'debit') return;  // Only expenses

                    // Check if this transaction is assigned to "General" project
                    var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });
                    var isGeneralProject = false;

                    if (txAllocs.length > 0) {
                        isGeneralProject = txAllocs.some(function(a) { return a.project_id === generalProjectId; });
                    }

                    if (isGeneralProject) {
                        // Transaction is assigned to General project - get its month
                        var txDate = t.settled_at || t.transaction_date || '';
                        if (txDate.length >= 7) {
                            var txMonth = txDate.substring(0, 7);  // "YYYY-MM"
                            var amt = Math.abs(parseFloat(t.amount) || 0);
                            var vatAmt = parseFloat(t.vat_amount) || 0;
                            if (excludeVat && vatAmt > 0) {
                                amt = amt - vatAmt;
                            }
                            if (!generalExpensesByMonth[txMonth]) generalExpensesByMonth[txMonth] = 0;
                            generalExpensesByMonth[txMonth] += amt;
                        }
                    }
                });

                // Distribute each month's General expenses according to monthly configuration
                Object.keys(generalExpensesByMonth).forEach(function(month) {
                    var monthExpense = generalExpensesByMonth[month];
                    var monthConfig = monthlyDistributions[month];

                    if (monthConfig && monthExpense > 0) {
                        // Calculate total configured percentage for this month
                        var totalPct = 0;
                        Object.keys(monthConfig).forEach(function(pid) {
                            totalPct += monthConfig[pid] || 0;
                        });

                        if (totalPct > 0) {
                            Object.keys(monthConfig).forEach(function(pid) {
                                var pct = monthConfig[pid] || 0;
                                if (pct > 0 && byProject[pid] && pid !== generalProjectId) {
                                    var distributedAmount = monthExpense * pct / totalPct;
                                    byProject[pid].expense += distributedAmount;
                                    byProject[pid].distributedExpense = (byProject[pid].distributedExpense || 0) + distributedAmount;
                                }
                            });

                            // Remove distributed amount from "General" project
                            var distributedTotal = monthExpense * Math.min(totalPct, 100) / 100;
                            if (byProject[generalProjectId]) {
                                byProject[generalProjectId].expense -= distributedTotal;
                            }
                        }
                    }
                });
            }

            var excludeUnassigned = document.getElementById('pl-projects-exclude-unassigned').checked;
            var statusFilter = document.getElementById('pl-projects-status').value;
            var sortBy = document.getElementById('pl-projects-sort').value;

            // Get project status from projects array
            var projectStatus = {};
            projects.forEach(function(p) { projectStatus[p.id] = p.status; });

            var projectList = Object.keys(byProject).map(function(id) {
                var p = byProject[id];
                p.id = id;
                p.status = projectStatus[id] || 'Active';
                p.totalCosts = p.expense;
                p.net = p.income - p.totalCosts;
                p.margin = p.income > 0 ? (p.net / p.income * 100) : 0;
                // Mark if this is the "General" project and has distributed expenses
                p.isGeneralProject = (id === generalProjectId);
                p.hasDistributedExpenses = p.isGeneralProject && (p.distributedExpense || 0) < 0;
                return p;
            }).filter(function(p) {
                if (excludeUnassigned && p.id === '_none') return false;
                if (statusFilter !== 'all' && p.id !== '_none' && p.status !== statusFilter) return false;
                return p.income > 0 || p.expense > 0;
            });

            // Sorting
            projectList.sort(function(a, b) {
                if (sortBy === 'margin') return b.margin - a.margin;
                if (sortBy === 'income') return b.income - a.income;
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                return 0;
            });

            // KPIs
            var filteredIncome = projectList.reduce(function(sum, p) { return sum + p.income; }, 0);
            var totalExpenses = projectList.reduce(function(sum, p) { return sum + p.totalCosts; }, 0);
            var globalNet = filteredIncome - totalExpenses;
            var globalMargin = filteredIncome > 0 ? (globalNet / filteredIncome * 100) : 0;

            document.getElementById('pl-projects-count').textContent = projectList.filter(function(p) { return p.id !== '_none'; }).length;
            document.getElementById('pl-projects-income').textContent = fmt(filteredIncome);
            document.getElementById('pl-projects-margin').textContent = globalMargin.toFixed(1) + '%';
            document.getElementById('pl-projects-margin').className = 'kpi-value ' + (globalMargin >= 0 ? 'positive' : 'negative');

            plProjectsData = projectList;
            renderPLProjectsChart();

            // Project cards - improved layout
            var html = '';
            projectList.forEach(function(p) {
                var marginColor = p.margin >= 20 ? '#10b981' : (p.margin >= 0 ? '#f59e0b' : '#ef4444');
                var marginBg = p.margin >= 20 ? '#dcfce7' : (p.margin >= 0 ? '#fef3c7' : '#fef2f2');

                // Special styling for "General" project
                var cardStyle = 'position:relative;cursor:pointer;';
                if (p.isGeneralProject) {
                    cardStyle += 'border:2px dashed #9ca3af;background:#f9fafb;';
                }

                html += '<div class="project-card" style="' + cardStyle + '" onclick="showProjectTransactions(\'' + p.id + '\')" title="Click para ver transacciones">';
                // Header with name and margin badge
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
                html += '<div class="project-name" style="margin:0;">' + p.name;
                // Badge for General project
                if (p.isGeneralProject) {
                    html += ' <span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;background:#e0e7ff;color:#4338ca;margin-left:6px;">Distribuido</span>';
                }
                html += '</div>';
                html += '<div style="padding:4px 12px;border-radius:20px;font-weight:700;font-size:14px;background:' + marginBg + ';color:' + marginColor + ';">' + p.margin.toFixed(1) + '%</div>';
                html += '</div>';
                // Main metrics in 2 columns
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">';
                html += '<div style="padding:8px;background:#f0fdf4;border-radius:6px;"><div style="font-size:11px;color:#666;">Ingresos</div><div style="font-size:16px;font-weight:600;color:#10b981;">' + fmt(p.income) + '</div></div>';
                html += '<div style="padding:8px;background:#fef2f2;border-radius:6px;"><div style="font-size:11px;color:#666;">Costos</div><div style="font-size:16px;font-weight:600;color:#ef4444;">' + fmt(p.totalCosts) + '</div></div>';
                html += '</div>';
                // Net result
                html += '<div style="padding:10px;background:' + (p.net >= 0 ? '#f0fdf4' : '#fef2f2') + ';border-radius:6px;text-align:center;">';
                html += '<div style="font-size:11px;color:#666;">Resultado Neto</div>';
                html += '<div style="font-size:20px;font-weight:700;color:' + (p.net >= 0 ? '#10b981' : '#ef4444') + ';">' + fmt(p.net) + '</div>';
                html += '</div>';
                html += '</div>';
            });

            document.getElementById('pl-projects-grid').innerHTML = html || '<div style="padding:40px;text-align:center;color:var(--text-muted);">No hay proyectos con transacciones</div>';
        }

        function renderPLProjectsChart() {
            var chartType = document.getElementById('pl-projects-chart-type').value;
            var ctx = document.getElementById('chart-projects');
            if (!ctx || plProjectsData.length === 0) return;

            if (projectsChart) projectsChart.destroy();

            var labels = plProjectsData.map(function(p) { return p.name; });

            if (chartType === 'margin') {
                var data = plProjectsData.map(function(p) { return p.margin; });
                var colors = data.map(function(v) { return v >= 0 ? '#10b981' : '#ef4444'; });
                projectsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Margen %',
                            data: data,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { callback: function(v) { return v + '%'; } } } }
                    }
                });
            } else {
                var incomes = plProjectsData.map(function(p) { return p.income; });
                var expenses = plProjectsData.map(function(p) { return p.totalCosts; });
                projectsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Ingresos', data: incomes, backgroundColor: '#10b981' },
                            { label: 'Gastos', data: expenses, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }

        function renderPLClients() {
            var byClient = {};
            var totalIncome = 0;

            // Check if VAT should be excluded
            var excludeVat = document.getElementById('pl-exclude-vat') ? document.getElementById('pl-exclude-vat').checked : false;

            clients.forEach(function(c) {
                byClient[c.id] = {id: c.id, name: c.name, income: 0, expense: 0, projects: {}};
            });
            byClient['_none'] = {id: '_none', name: 'Sin cliente', income: 0, expense: 0, projects: {}};

            // Get project info per client
            projects.forEach(function(p) {
                var clientId = '_none';
                clients.forEach(function(c) {
                    if (p.client === c.name) clientId = c.id;
                });
                if (!byClient[clientId].projects[p.id]) {
                    byClient[clientId].projects[p.id] = {name: p.name, income: 0, expense: 0};
                }
            });

            // Add transaction amounts
            transactions.forEach(function(t) {
                // Skip excluded transactions
                if (t.is_excluded) return;

                var amt = parseFloat(t.amount) || 0;
                var vatAmt = parseFloat(t.vat_amount) || 0;

                // Subtract VAT if checkbox is checked
                if (excludeVat && vatAmt > 0) {
                    amt = amt - vatAmt;
                }

                var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });

                if (txAllocs.length > 0) {
                    var totalAllocPct = 0;
                    txAllocs.forEach(function(alloc) {
                        var allocAmt = amt * alloc.percentage / 100;
                        totalAllocPct += alloc.percentage;
                        var cid = alloc.client_id || '_none';
                        var pid = alloc.project_id;

                        if (byClient[cid]) {
                            if (t.side === 'credit') {
                                byClient[cid].income += allocAmt;
                                if (pid && byClient[cid].projects[pid]) byClient[cid].projects[pid].income += allocAmt;
                            } else {
                                byClient[cid].expense += allocAmt;
                                if (pid && byClient[cid].projects[pid]) byClient[cid].projects[pid].expense += allocAmt;
                            }
                        }
                    });
                    // If allocations don't sum to 100%, assign remainder to "Sin cliente"
                    if (totalAllocPct < 100) {
                        var remainderAmt = amt * (100 - totalAllocPct) / 100;
                        if (byClient['_none']) {
                            if (t.side === 'credit') {
                                byClient['_none'].income += remainderAmt;
                            } else {
                                byClient['_none'].expense += remainderAmt;
                            }
                        }
                    }
                } else {
                    // No allocations - assign to "Sin cliente"
                    if (byClient['_none']) {
                        if (t.side === 'credit') {
                            byClient['_none'].income += amt;
                        } else {
                            byClient['_none'].expense += amt;
                        }
                    }
                }
                if (t.side === 'credit') totalIncome += amt;
            });

            // ==================== Monthly Distribution of General Expenses ====================
            // Find "General" project (bucket for distributable expenses)
            var generalProjectId = null;
            projects.forEach(function(p) {
                if (p.name && p.name.toLowerCase() === 'general') {
                    generalProjectId = p.id;
                }
            });

            // Distribute "General" project expenses to clients based on monthly project distributions
            if (generalProjectId && Object.keys(monthlyDistributions).length > 0) {
                // Build project -> client mapping
                var projectToClient = {};
                projects.forEach(function(p) {
                    var clientId = '_none';
                    clients.forEach(function(c) {
                        if (p.client === c.name) clientId = c.id;
                    });
                    projectToClient[p.id] = clientId;
                });

                // Group "General" project expenses by month
                var generalExpensesByMonth = {};
                transactions.forEach(function(t) {
                    if (t.is_excluded) return;
                    if (t.side !== 'debit') return;

                    // Check if transaction is assigned to "General" project
                    var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === t.id; });
                    var isGeneralProject = txAllocs.some(function(a) { return a.project_id === generalProjectId; });

                    if (isGeneralProject) {
                        var txDate = t.settled_at || t.transaction_date || '';
                        if (txDate.length >= 7) {
                            var txMonth = txDate.substring(0, 7);
                            var amt = Math.abs(parseFloat(t.amount) || 0);
                            var vatAmt = parseFloat(t.vat_amount) || 0;
                            if (excludeVat && vatAmt > 0) amt = amt - vatAmt;
                            if (!generalExpensesByMonth[txMonth]) generalExpensesByMonth[txMonth] = 0;
                            generalExpensesByMonth[txMonth] += amt;
                        }
                    }
                });

                // Distribute each month's General expenses via projects -> clients
                Object.keys(generalExpensesByMonth).forEach(function(month) {
                    var monthExpense = generalExpensesByMonth[month];
                    var monthConfig = monthlyDistributions[month];

                    if (monthConfig && monthExpense > 0) {
                        var totalPct = 0;
                        Object.keys(monthConfig).forEach(function(pid) {
                            totalPct += monthConfig[pid] || 0;
                        });

                        if (totalPct > 0) {
                            Object.keys(monthConfig).forEach(function(pid) {
                                var pct = monthConfig[pid] || 0;
                                if (pct > 0 && pid !== generalProjectId) {
                                    var distributedAmount = monthExpense * pct / totalPct;
                                    // Get client from project
                                    var clientId = projectToClient[pid] || '_none';
                                    if (byClient[clientId]) {
                                        byClient[clientId].expense += distributedAmount;
                                        byClient[clientId].generalExpenseShare = (byClient[clientId].generalExpenseShare || 0) + distributedAmount;
                                    }
                                }
                            });

                            // Remove distributed amount from "General" project's client (if any)
                            var generalClientId = projectToClient[generalProjectId] || '_none';
                            var distributedTotal = monthExpense * Math.min(totalPct, 100) / 100;
                            if (byClient[generalClientId]) {
                                byClient[generalClientId].expense -= distributedTotal;
                            }
                        }
                    }
                });
            }

            var excludeUnassigned = document.getElementById('pl-clients-exclude-unassigned').checked;
            var sortBy = document.getElementById('pl-clients-sort').value;

            var clientList = Object.values(byClient).filter(function(c) {
                if (excludeUnassigned && c.id === '_none') return false;
                return c.income > 0 || c.expense > 0;
            }).map(function(c) {
                c.net = c.income - c.expense;
                c.margin = c.income > 0 ? (c.net / c.income * 100) : 0;
                return c;
            });

            // Sorting
            clientList.sort(function(a, b) {
                if (sortBy === 'margin') return b.margin - a.margin;
                if (sortBy === 'income') return b.income - a.income;
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                return 0;
            });

            // Check for negative margin clients
            var negativeClients = clientList.filter(function(c) { return c.margin < 0 && c.id !== '_none'; });
            var alertEl = document.getElementById('pl-clients-alert');
            if (negativeClients.length > 0) {
                var names = negativeClients.map(function(c) { return c.name; }).join(', ');
                document.getElementById('pl-clients-alert-text').textContent = negativeClients.length + ' cliente(s) con margen negativo: ' + names;
                alertEl.classList.remove('hidden');
            } else {
                alertEl.classList.add('hidden');
            }

            // KPIs
            var filteredIncome = clientList.reduce(function(sum, c) { return sum + c.income; }, 0);
            var totalExpenses = clientList.reduce(function(sum, c) { return sum + c.expense; }, 0);
            var globalNet = filteredIncome - totalExpenses;
            var globalMargin = filteredIncome > 0 ? (globalNet / filteredIncome * 100) : 0;

            // Top client by income
            var topClient = clientList.filter(function(c) { return c.id !== '_none'; }).sort(function(a,b) { return b.income - a.income; })[0];

            document.getElementById('pl-clients-count').textContent = clientList.filter(function(c) { return c.id !== '_none'; }).length;
            document.getElementById('pl-clients-income').textContent = fmt(filteredIncome);
            document.getElementById('pl-clients-margin').textContent = globalMargin.toFixed(1) + '%';
            document.getElementById('pl-clients-margin').className = 'kpi-value ' + (globalMargin >= 0 ? 'positive' : 'negative');
            document.getElementById('pl-clients-top').textContent = topClient ? topClient.name : '-';

            // Store for chart
            plClientsData = clientList;
            renderPLClientsChart();

            // Client cards - improved layout
            var html = '';
            clientList.forEach(function(c) {
                var marginColor = c.margin >= 20 ? '#10b981' : (c.margin >= 0 ? '#f59e0b' : '#ef4444');
                var marginBg = c.margin >= 20 ? '#dcfce7' : (c.margin >= 0 ? '#fef3c7' : '#fef2f2');
                var isNegative = c.margin < 0;

                html += '<div class="client-section" style="cursor:pointer;' + (isNegative ? 'border-left:3px solid #ef4444;' : '') + '" onclick="showClientTransactions(\'' + c.id + '\')" title="Click para ver transacciones">';
                html += '<div class="client-header" style="display:flex;justify-content:space-between;align-items:flex-start;">';
                html += '<div>';
                html += '<h3 style="margin:0 0 8px 0;">' + c.name + (isNegative ? ' <span style="color:#ef4444;font-size:14px;">⚠</span>' : '') + '</h3>';
                html += '<div style="display:flex;gap:16px;font-size:13px;">';
                html += '<span>Ingresos: <strong class="positive">' + fmt(c.income) + '</strong></span>';
                html += '<span>Gastos: <strong class="negative">' + fmt(c.expense) + '</strong></span>';
                html += '<span>Neto: <strong class="' + (c.net >= 0 ? 'positive' : 'negative') + '">' + fmt(c.net) + '</strong></span>';
                html += '</div></div>';
                html += '<div style="padding:6px 14px;border-radius:20px;font-weight:700;background:' + marginBg + ';color:' + marginColor + ';">' + c.margin.toFixed(1) + '%</div>';
                html += '</div>';

                var projList = Object.values(c.projects).filter(function(p) { return p.income > 0 || p.expense > 0; });
                if (projList.length > 0) {
                    html += '<div class="client-projects">';
                    projList.forEach(function(p) {
                        var pNet = p.income - p.expense;
                        var pMargin = p.income > 0 ? (pNet / p.income * 100) : 0;
                        html += '<div class="top-item">';
                        html += '<span class="top-item-name">' + p.name + '</span>';
                        html += '<span style="display:flex;gap:16px;font-size:13px;">';
                        html += '<span>' + fmt(p.income) + '</span>';
                        html += '<span class="' + (pNet >= 0 ? 'positive' : 'negative') + '">' + fmt(pNet) + ' (' + pMargin.toFixed(0) + '%)</span>';
                        html += '</span></div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            });
            document.getElementById('pl-clients-grid').innerHTML = html || '<div style="padding:40px;text-align:center;color:var(--text-muted);">No hay clientes con transacciones</div>';
        }

        function renderPLClientsChart() {
            var chartType = document.getElementById('pl-clients-chart-type').value;
            var ctx = document.getElementById('chart-clients');
            if (!ctx || plClientsData.length === 0) return;

            if (clientsChart) clientsChart.destroy();

            var labels = plClientsData.map(function(c) { return c.name; });

            if (chartType === 'margin') {
                var data = plClientsData.map(function(c) { return c.margin; });
                var colors = data.map(function(v) { return v >= 0 ? '#10b981' : '#ef4444'; });
                clientsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Margen %',
                            data: data,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { callback: function(v) { return v + '%'; } } } }
                    }
                });
            } else {
                var incomes = plClientsData.map(function(c) { return c.income; });
                var expenses = plClientsData.map(function(c) { return c.expense; });
                clientsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Ingresos', data: incomes, backgroundColor: '#10b981' },
                            { label: 'Gastos', data: expenses, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }

        // Actions
        function syncQonto() {
            if (!confirm('Sincronizar transacciones desde Qonto?')) return;
            fetch('/api/sync', {method: 'POST'}).then(function(r) { return r.json(); }).then(function(data) {
                var msg = 'Qonto: ' + (data.qonto_count || 0) + ' transacciones\n';
                msg += 'Nuevas: ' + (data.synced || 0) + '\n';
                msg += 'Existentes: ' + (data.skipped || 0) + '\n';
                msg += 'Categorias actualizadas: ' + (data.categories_updated || 0);
                if (data.fields_found) {
                    if (!data.fields_found.qonto_category) {
                        msg += '\n\n⚠️ Campo "Qonto Category" no encontrado en Airtable.\nCrea un campo llamado "Qonto Category" (tipo texto) en la tabla Transactions.';
                    }
                }
                if (data.error) msg += '\n\nError: ' + data.error;
                alert(msg);
                loadData();
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function saveTransaction() {
            var data = {
                type: document.getElementById('new-tx-type').value,
                date: document.getElementById('new-tx-date').value,
                amount: parseFloat(document.getElementById('new-tx-amount').value) || 0,
                description: document.getElementById('new-tx-description').value,
                counterparty: document.getElementById('new-tx-counterparty').value
            };

            if (!data.amount || !data.date) {
                alert('Por favor completa monto y fecha');
                return;
            }

            fetch('/api/transaction', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('add-transaction');
                    loadData();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        // ==================== Service Offerings (Ofertas G4U) ====================

        var serviceOfferings = [];

        function loadOfferings() {
            fetch('/api/settings/offerings').then(function(r) { return r.json(); }).then(function(data) {
                serviceOfferings = data.offerings || [];
                renderOfferings();
            }).catch(function(e) {
                console.error('Error loading offerings:', e);
            });
        }

        function renderOfferings() {
            var html = '';
            serviceOfferings.forEach(function(offering, index) {
                html += '<tr>';
                html += '<td><input type="text" value="' + (offering.id || '') + '" onchange="updateOffering(' + index + ', \'id\', this.value)" style="width:100%;border:1px solid var(--border);border-radius:4px;padding:6px 8px;"></td>';
                html += '<td><input type="text" value="' + (offering.name || '') + '" onchange="updateOffering(' + index + ', \'name\', this.value)" style="width:100%;border:1px solid var(--border);border-radius:4px;padding:6px 8px;"></td>';
                html += '<td style="text-align:center;"><button class="btn btn-sm btn-outline" onclick="removeOffering(' + index + ')" style="color:var(--danger);">Eliminar</button></td>';
                html += '</tr>';
            });
            if (serviceOfferings.length === 0) {
                html = '<tr><td colspan="3" class="text-muted" style="text-align:center;padding:20px;">No hay ofertas configuradas</td></tr>';
            }
            document.getElementById('offerings-table').innerHTML = html;
        }

        function addOffering() {
            serviceOfferings.push({ id: '', name: '' });
            renderOfferings();
            // Focus on the new row's ID input
            var inputs = document.querySelectorAll('#offerings-table input');
            if (inputs.length > 0) {
                inputs[inputs.length - 2].focus();  // Focus on ID input of last row
            }
        }

        function updateOffering(index, field, value) {
            if (serviceOfferings[index]) {
                serviceOfferings[index][field] = value;
            }
        }

        function removeOffering(index) {
            serviceOfferings.splice(index, 1);
            renderOfferings();
        }

        function saveOfferings() {
            // Validate
            for (var i = 0; i < serviceOfferings.length; i++) {
                if (!serviceOfferings[i].id || !serviceOfferings[i].name) {
                    alert('Todas las ofertas deben tener ID y Nombre');
                    return;
                }
            }

            fetch('/api/settings/offerings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ offerings: serviceOfferings })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Ofertas guardadas correctamente');
                    // Update project modals with new offerings
                    populateOfferingsSelects();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function populateOfferingsSelects() {
            // Populate both new-project and edit-project service selects
            var selects = ['new-project-service', 'edit-project-service'];
            selects.forEach(function(selectId) {
                var select = document.getElementById(selectId);
                if (!select) return;
                var currentValue = select.value;
                var html = '<option value="">Selecciona una oferta</option>';
                serviceOfferings.forEach(function(offering) {
                    html += '<option value="' + offering.id + '">' + offering.name + '</option>';
                });
                select.innerHTML = html;
                select.value = currentValue;  // Restore selection
            });
        }

        // ==================== Team Members ====================

        function loadTeamMembers() {
            fetch('/api/team-members').then(function(r) { return r.json(); }).then(function(data) {
                teamMembers = data.members || [];
                renderTeamMembers();
                populateAllocationSelects();
            }).catch(function(e) {
                console.error('Error loading team members:', e);
            });
        }

        function renderTeamMembers() {
            var html = '';
            teamMembers.forEach(function(m) {
                html += '<tr>';
                html += '<td>' + (m.name || '-') + '</td>';
                html += '<td>' + (m.role || '-') + '</td>';
                html += '<td style="text-align:right" class="amount">' + fmt(m.salary) + '</td>';
                html += '<td><button class="btn btn-sm btn-outline" onclick="editTeamMember(\'' + m.id + '\')">Editar</button> ';
                html += '<button class="btn btn-sm btn-outline" onclick="deleteTeamMember(\'' + m.id + '\')" style="color:var(--danger);">X</button></td>';
                html += '</tr>';
            });
            document.getElementById('team-members-table').innerHTML = html || '<tr><td colspan="4" class="text-muted" style="text-align:center;padding:20px;">No hay miembros. Crea la tabla "Team Members" en Airtable con campos: Name, Role, Salary</td></tr>';
        }

        function saveTeamMember() {
            var data = {
                name: document.getElementById('new-member-name').value,
                role: document.getElementById('new-member-role').value,
                salary: parseFloat(document.getElementById('new-member-salary').value) || 0
            };

            if (!data.name) {
                alert('Por favor ingresa un nombre');
                return;
            }

            fetch('/api/team-member', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('add-member');
                    document.getElementById('new-member-name').value = '';
                    document.getElementById('new-member-role').value = '';
                    document.getElementById('new-member-salary').value = '';
                    loadTeamMembers();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function editTeamMember(id) {
            var member = teamMembers.find(function(m) { return m.id === id; });
            if (!member) return;
            document.getElementById('edit-member-id').value = id;
            document.getElementById('edit-member-name').value = member.name || '';
            document.getElementById('edit-member-role').value = member.role || '';
            document.getElementById('edit-member-salary').value = member.salary || '';
            openModal('edit-member');
        }

        function updateTeamMember() {
            var id = document.getElementById('edit-member-id').value;
            var data = {
                name: document.getElementById('edit-member-name').value,
                role: document.getElementById('edit-member-role').value,
                salary: parseFloat(document.getElementById('edit-member-salary').value) || 0
            };

            fetch('/api/team-member/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('edit-member');
                    loadTeamMembers();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function deleteTeamMember(id) {
            if (!confirm('Eliminar este miembro del equipo?')) return;
            fetch('/api/team-member/' + id, { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else loadTeamMembers();
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        // ==================== AI Brain ====================

        var aiChatHistory = [];
        var selectedAIModel = 'groq-llama3-70b';

        function loadAISettings() {
            fetch('/api/ai/settings').then(function(r) { return r.json(); }).then(function(data) {
                if (data.model) {
                    selectedAIModel = data.model;
                    var selector = document.getElementById('ai-model-selector');
                    if (selector) selector.value = selectedAIModel;
                }
            }).catch(function(e) {
                console.error('Error loading AI settings:', e);
            });
        }

        function saveAIModel() {
            var selector = document.getElementById('ai-model-selector');
            if (!selector) return;
            selectedAIModel = selector.value;
            fetch('/api/ai/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: selectedAIModel})
            }).catch(function(e) {
                console.error('Error saving AI model:', e);
            });
        }

        function getFinancialContext() {
            // Build context from current data
            var context = 'DATOS FINANCIEROS ACTUALES:\n\n';

            // Summary
            context += 'RESUMEN:\n';
            context += '- Ingresos totales: ' + fmt(totalIncome) + '\n';
            context += '- Gastos totales: ' + fmt(totalExpenses) + '\n';
            context += '- Balance: ' + fmt(totalIncome - totalExpenses) + '\n';
            context += '- Margen: ' + ((totalIncome > 0) ? ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1) : 0) + '%\n\n';

            // By category
            context += 'GASTOS POR CATEGORIA:\n';
            var catSummary = {};
            transactions.filter(function(t) { return t.side === 'debit'; }).forEach(function(t) {
                var cat = t.category || 'Sin categoria';
                catSummary[cat] = (catSummary[cat] || 0) + Math.abs(t.amount);
            });
            Object.keys(catSummary).sort(function(a,b) { return catSummary[b] - catSummary[a]; }).forEach(function(cat) {
                context += '- ' + cat + ': ' + fmt(catSummary[cat]) + '\n';
            });

            // By project
            context += '\nINGRESOS/GASTOS POR PROYECTO:\n';
            projects.forEach(function(p) {
                var pIncome = 0, pExpense = 0;
                transactions.forEach(function(t) {
                    if (t.project_id === p.id || t.project_name === p.name) {
                        if (t.side === 'credit') pIncome += t.amount;
                        else pExpense += Math.abs(t.amount);
                    }
                });
                if (pIncome > 0 || pExpense > 0) {
                    context += '- ' + p.name + ': Ingresos ' + fmt(pIncome) + ', Gastos ' + fmt(pExpense) + '\n';
                }
            });

            return context;
        }

        function sendAIMessage() {
            var input = document.getElementById('ai-chat-input');
            var message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.disabled = true;

            // Add user message to chat
            addChatMessage('user', message);

            // Show loading
            var loadingId = addChatMessage('assistant', '<em>Pensando...</em>', true);

            // Get financial context
            var context = getFinancialContext();

            // Add to history (limit to last 20 messages to avoid token overflow)
            aiChatHistory.push({role: 'user', content: message});
            if (aiChatHistory.length > 20) {
                aiChatHistory = aiChatHistory.slice(-20);
            }

            // Use Supabase Edge Function for AI (150s timeout vs Vercel's 10s)
            fetch('https://zslfbaktftdjsrsxmqgb.supabase.co/functions/v1/ai-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: selectedAIModel,
                    messages: aiChatHistory,
                    context: context
                })
            }).then(function(r) { return r.json(); }).then(function(data) {
                // Remove ALL loading messages (more robust)
                removeLoadingMessages();

                if (data.error) {
                    addChatMessage('assistant', 'Error: ' + data.error);
                } else {
                    var response = data.response || 'Sin respuesta';
                    aiChatHistory.push({role: 'assistant', content: response});
                    addChatMessage('assistant', formatAIResponse(response));
                }
                input.disabled = false;
                input.focus();
            }).catch(function(e) {
                removeLoadingMessages();
                addChatMessage('assistant', 'Error de conexion: ' + e.message);
                input.disabled = false;
            });
        }

        function addChatMessage(role, content, isLoading) {
            var container = document.getElementById('ai-chat-messages');
            if (!container) return null;

            var id = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            var div = document.createElement('div');
            div.id = id;
            div.className = 'chat-message ' + role + (isLoading ? ' loading-message' : '');
            div.style.cssText = 'padding:12px 16px;margin:8px 0;border-radius:12px;max-width:85%;' +
                (role === 'user' ? 'background:var(--primary);color:white;margin-left:auto;' : 'background:var(--card-bg);border:1px solid var(--border);');

            // Security: Escape user input to prevent XSS
            if (role === 'user' && !isLoading) {
                div.textContent = content;
            } else {
                div.innerHTML = content;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            return id;
        }

        function removeLoadingMessages() {
            var loadingMsgs = document.querySelectorAll('.loading-message');
            loadingMsgs.forEach(function(el) { el.remove(); });
        }

        function formatAIResponse(text) {
            // Convert markdown-style formatting to HTML

            // First, handle code blocks (preserve them)
            var codeBlocks = [];
            text = text.replace(/```([\s\S]*?)```/g, function(match, code) {
                codeBlocks.push(code);
                return '%%CODE_BLOCK_' + (codeBlocks.length - 1) + '%%';
            });

            // Handle markdown tables
            text = text.replace(/(?:^|\n)(\|.+\|)\n(\|[-:| ]+\|)\n((?:\|.+\|\n?)+)/g, function(match, header, separator, body) {
                var headers = header.split('|').filter(function(c) { return c.trim(); });
                var rows = body.trim().split('\n');

                var html = '<table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:14px;">';
                html += '<thead><tr>';
                headers.forEach(function(h) {
                    html += '<th style="border:1px solid var(--border);padding:8px 12px;background:var(--primary);color:white;text-align:left;">' + h.trim() + '</th>';
                });
                html += '</tr></thead><tbody>';

                rows.forEach(function(row) {
                    var cells = row.split('|').filter(function(c) { return c.trim() !== ''; });
                    if (cells.length > 0) {
                        html += '<tr>';
                        cells.forEach(function(cell) {
                            html += '<td style="border:1px solid var(--border);padding:8px 12px;">' + cell.trim() + '</td>';
                        });
                        html += '</tr>';
                    }
                });

                html += '</tbody></table>';
                return html;
            });

            // Bold and italic
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Headers
            text = text.replace(/^### (.+)$/gm, '<h4 style="margin:16px 0 8px;color:var(--primary);">$1</h4>');
            text = text.replace(/^## (.+)$/gm, '<h3 style="margin:16px 0 8px;color:var(--primary);">$1</h3>');
            text = text.replace(/^# (.+)$/gm, '<h2 style="margin:16px 0 8px;color:var(--primary);">$1</h2>');

            // Lists
            text = text.replace(/^- (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;">$1</li>');
            text = text.replace(/^(\d+)\. (.+)$/gm, '<li style="margin:4px 0;margin-left:20px;">$2</li>');

            // Line breaks (but not inside tables which are already HTML)
            text = text.replace(/\n/g, '<br>');

            // Restore code blocks
            codeBlocks.forEach(function(code, i) {
                text = text.replace('%%CODE_BLOCK_' + i + '%%', '<pre style="background:#1a1a2e;padding:10px;border-radius:6px;overflow-x:auto;margin:8px 0;">' + code + '</pre>');
            });

            return text;
        }

        function runAIScenario(scenario) {
            var container = document.getElementById('ai-chat-messages');
            if (!container) return;

            // Show loading
            var loadingId = addChatMessage('assistant', '<em>Ejecutando escenario: ' + scenario + '...</em>', true);

            var context = getFinancialContext();

            // Use Supabase Edge Function for AI scenarios (150s timeout)
            fetch('https://zslfbaktftdjsrsxmqgb.supabase.co/functions/v1/ai-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: selectedAIModel,
                    scenario: scenario,
                    context: context
                })
            }).then(function(r) { return r.json(); }).then(function(data) {
                removeLoadingMessages();

                if (data.error) {
                    addChatMessage('assistant', 'Error: ' + data.error);
                } else {
                    addChatMessage('assistant', formatAIResponse(data.response || 'Sin respuesta'));
                }
            }).catch(function(e) {
                removeLoadingMessages();
                addChatMessage('assistant', 'Error: ' + e.message);
            });
        }

        function clearAIChat() {
            aiChatHistory = [];
            var container = document.getElementById('ai-chat-messages');
            if (container) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px;">Inicia una conversacion o selecciona un escenario</div>';
            }
        }

        // ==================== Projects CRUD ====================

        function loadProjectsSettings() {
            fetch('/api/projects').then(function(r) { return r.json(); }).then(function(data) {
                projects = data.projects || [];
                renderProjectsSettings();
                populateAllocationSelects();
            }).catch(function(e) {
                console.error('Error loading projects:', e);
            });
        }

        function renderProjectsSettings() {
            var html = '';
            projects.forEach(function(p) {
                // Client is now stored as text (name), not ID
                var clientName = p.client || '-';

                // Resolve service ID(s) to name(s)
                var serviceName = '-';
                if (Array.isArray(p.service) && p.service.length > 0) {
                    // Service is linked record (array of IDs) - resolve to names
                    var names = p.service.map(function(serviceId) {
                        var offering = offerings.find(function(o) { return o.id === serviceId; });
                        return offering ? offering.name : serviceId;
                    });
                    serviceName = names.join(', ');
                } else if (typeof p.service === 'string' && p.service) {
                    // Legacy string - could be name or ID
                    if (p.service.startsWith('rec')) {
                        var offering = offerings.find(function(o) { return o.id === p.service; });
                        serviceName = offering ? offering.name : p.service;
                    } else {
                        serviceName = p.service;
                    }
                }

                var statusClass = p.status === 'Active' ? 'ok' : (p.status === 'Completed' ? '' : 'pending');
                var startDate = p.start_date || '-';
                var endDate = p.end_date || '-';
                html += '<tr>';
                html += '<td><strong>' + (p.name || '-') + '</strong></td>';
                html += '<td>' + serviceName + '</td>';
                html += '<td>' + clientName + '</td>';
                html += '<td>' + startDate + '</td>';
                html += '<td>' + endDate + '</td>';
                html += '<td><span class="status ' + statusClass + '">' + (p.status || 'Active') + '</span></td>';
                html += '<td><button class="btn btn-sm btn-outline" onclick="editProject(\'' + p.id + '\')">Editar</button> ';
                html += '<button class="btn btn-sm btn-outline" onclick="deleteProject(\'' + p.id + '\')" style="color:var(--danger);">X</button></td>';
                html += '</tr>';
            });
            document.getElementById('projects-table').innerHTML = html || '<tr><td colspan="7" class="text-muted" style="text-align:center;padding:20px;">No hay proyectos</td></tr>';
        }

        function saveProject() {
            var data = {
                name: document.getElementById('new-project-name').value,
                service: document.getElementById('new-project-service').value,
                client: document.getElementById('new-project-client').value,
                status: document.getElementById('new-project-status').value,
                start_date: document.getElementById('new-project-start-date').value,
                end_date: document.getElementById('new-project-end-date').value
            };

            if (!data.name) {
                alert('Por favor ingresa un titulo de proyecto');
                return;
            }

            fetch('/api/project', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('add-project');
                    document.getElementById('new-project-name').value = '';
                    document.getElementById('new-project-service').value = '';
                    document.getElementById('new-project-client').value = '';
                    document.getElementById('new-project-start-date').value = '';
                    document.getElementById('new-project-end-date').value = '';
                    loadProjectsSettings();
                    loadData(); // reload main data
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function editProject(id) {
            var project = projects.find(function(p) { return p.id === id; });
            if (!project) return;
            document.getElementById('edit-project-id').value = id;
            document.getElementById('edit-project-name').value = project.name || '';

            // Service is a linked record (array of IDs) - get first ID
            // Also handle legacy string codes like "GTM" by mapping to Airtable ID
            var serviceId = '';
            if (Array.isArray(project.service) && project.service.length > 0) {
                serviceId = project.service[0];
            } else if (typeof project.service === 'string' && project.service) {
                // Check if it's already an Airtable record ID (starts with "rec")
                if (project.service.startsWith('rec')) {
                    serviceId = project.service;
                } else {
                    // Legacy code - try to find matching offering by name
                    var matchingOffering = offerings.find(function(o) {
                        return o.name.toLowerCase().includes(project.service.toLowerCase()) ||
                               project.service.toLowerCase().includes(o.name.split(' ')[0].toLowerCase());
                    });
                    if (matchingOffering) {
                        serviceId = matchingOffering.id;
                    }
                }
            }
            populateOfferingsSelect('edit-project-service', serviceId);

            document.getElementById('edit-project-client').value = project.client || '';
            document.getElementById('edit-project-status').value = project.status || 'Active';
            document.getElementById('edit-project-start-date').value = project.start_date || '';
            document.getElementById('edit-project-end-date').value = project.end_date || '';
            openModal('edit-project');
        }

        function updateProject() {
            var id = document.getElementById('edit-project-id').value;
            var data = {
                name: document.getElementById('edit-project-name').value,
                service: document.getElementById('edit-project-service').value,
                client: document.getElementById('edit-project-client').value,
                status: document.getElementById('edit-project-status').value,
                start_date: document.getElementById('edit-project-start-date').value,
                end_date: document.getElementById('edit-project-end-date').value
            };

            fetch('/api/project/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('edit-project');
                    loadProjectsSettings();
                    loadData();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function deleteProject(id) {
            if (!confirm('Eliminar este proyecto?')) return;
            fetch('/api/project/' + id, { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else { loadProjectsSettings(); loadData(); }
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        // ==================== Categories CRUD ====================

        function loadCategories() {
            fetch('/api/categories').then(function(r) { return r.json(); }).then(function(data) {
                categories = data.categories || [];
                renderCategoriesSettings();
            }).catch(function(e) {
                console.error('Error loading categories:', e);
            });
        }

        function renderCategoriesSettings() {
            var html = '';
            categories.forEach(function(c) {
                var typeLabel = c.type === 'Income' ? 'Ingreso' : 'Gasto';
                var typeClass = c.type === 'Income' ? 'ok' : '';
                html += '<tr>';
                html += '<td>' + (c.name || '-') + '</td>';
                html += '<td><span class="status ' + typeClass + '">' + typeLabel + '</span></td>';
                html += '<td><button class="btn btn-sm btn-outline" onclick="editCategory(\'' + c.id + '\')">Editar</button> ';
                html += '<button class="btn btn-sm btn-outline" onclick="deleteCategory(\'' + c.id + '\')" style="color:var(--danger);">X</button></td>';
                html += '</tr>';
            });
            document.getElementById('categories-table').innerHTML = html || '<tr><td colspan="3" class="text-muted" style="text-align:center;padding:20px;">No hay categorias. Crea la tabla "Categories" en Airtable con campos: Name, Type (Income/Expense)</td></tr>';
        }

        function saveCategory() {
            var data = {
                name: document.getElementById('new-category-name').value,
                type: document.getElementById('new-category-type').value
            };

            if (!data.name) {
                alert('Por favor ingresa un nombre');
                return;
            }

            fetch('/api/category', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('add-category');
                    document.getElementById('new-category-name').value = '';
                    loadCategories();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function editCategory(id) {
            var category = categories.find(function(c) { return c.id === id; });
            if (!category) return;
            document.getElementById('edit-category-id').value = id;
            document.getElementById('edit-category-name').value = category.name || '';
            document.getElementById('edit-category-type').value = category.type || 'Expense';
            openModal('edit-category');
        }

        function updateCategory() {
            var id = document.getElementById('edit-category-id').value;
            var data = {
                name: document.getElementById('edit-category-name').value,
                type: document.getElementById('edit-category-type').value
            };

            fetch('/api/category/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('edit-category');
                    loadCategories();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function deleteCategory(id) {
            if (!confirm('Eliminar esta categoria?')) return;
            fetch('/api/category/' + id, { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else loadCategories();
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        // ==================== Clients CRUD ====================

        function loadClients() {
            fetch('/api/clients').then(function(r) { return r.json(); }).then(function(data) {
                clients = data.clients || [];
                renderClientsSettings();
                populateProjectClientSelect();
            }).catch(function(e) {
                console.error('Error loading clients:', e);
            });
        }

        function renderClientsSettings() {
            var html = '';
            clients.forEach(function(c) {
                var status = c.status || 'Activo';
                var statusCls = status === 'Activo' ? 'ingreso' : 'gasto';
                html += '<tr>';
                html += '<td>' + (c.name || '-') + '</td>';
                html += '<td>' + (c.contact || '-') + '</td>';
                html += '<td>' + (c.email || '-') + '</td>';
                html += '<td>' + (c.phone || '-') + '</td>';
                html += '<td><span class="type-badge ' + statusCls + '" style="cursor:pointer;" onclick="toggleClientStatus(\'' + c.id + '\',\'' + status + '\')">' + status + '</span></td>';
                html += '<td><button class="btn btn-sm btn-outline" onclick="editClient(\'' + c.id + '\')">Editar</button> <button class="btn btn-sm btn-outline" onclick="deleteClient(\'' + c.id + '\')" style="color:var(--danger);">X</button></td>';
                html += '</tr>';
            });
            document.getElementById('clients-table').innerHTML = html || '<tr><td colspan="6" class="text-muted" style="text-align:center;padding:20px;">No hay clientes</td></tr>';
        }

        function toggleClientStatus(clientId, currentStatus) {
            var newStatus = currentStatus === 'Activo' ? 'Inactivo' : 'Activo';
            fetch('/api/client/' + clientId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: newStatus })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    loadClients();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        // ==================== Column Visibility ====================
        var columnVisibility = JSON.parse(localStorage.getItem('columnVisibility') || '{}');

        function toggleColumnMenu(tableId) {
            var menu = document.getElementById('column-menu-' + tableId);
            var isOpen = menu.classList.contains('show');
            // Close all menus
            document.querySelectorAll('.column-toggle-menu').forEach(function(m) { m.classList.remove('show'); });
            if (!isOpen) menu.classList.add('show');
        }

        function toggleColumn(tableId, colIndex, visible) {
            var table = document.getElementById('table-' + tableId);
            if (!table) return;
            var rows = table.querySelectorAll('tr');
            rows.forEach(function(row) {
                var cells = row.querySelectorAll('th, td');
                if (cells[colIndex]) {
                    cells[colIndex].style.display = visible ? '' : 'none';
                }
            });
            // Save preference
            if (!columnVisibility[tableId]) columnVisibility[tableId] = {};
            columnVisibility[tableId][colIndex] = visible;
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
        }

        function applyColumnVisibility(tableId) {
            var prefs = columnVisibility[tableId] || {};
            var menu = document.getElementById('column-menu-' + tableId);
            if (menu) {
                var checkboxes = menu.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(function(cb, i) {
                    var visible = prefs[i] !== false;
                    cb.checked = visible;
                    toggleColumn(tableId, i, visible);
                });
            }
        }

        // Close column menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.column-toggle')) {
                document.querySelectorAll('.column-toggle-menu').forEach(function(m) { m.classList.remove('show'); });
            }
        });

        function saveClient() {
            var data = {
                name: document.getElementById('new-client-name').value,
                contact: document.getElementById('new-client-contact').value,
                email: document.getElementById('new-client-email').value,
                phone: document.getElementById('new-client-phone').value,
                notes: document.getElementById('new-client-notes').value,
                status: document.getElementById('new-client-status').value
            };

            if (!data.name) {
                alert('Por favor ingresa un nombre');
                return;
            }

            fetch('/api/client', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('add-client');
                    document.getElementById('new-client-name').value = '';
                    document.getElementById('new-client-contact').value = '';
                    document.getElementById('new-client-email').value = '';
                    document.getElementById('new-client-phone').value = '';
                    document.getElementById('new-client-notes').value = '';
                    loadClients();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function editClient(id) {
            var client = clients.find(function(c) { return c.id === id; });
            if (!client) return;
            document.getElementById('edit-client-id').value = id;
            document.getElementById('edit-client-name').value = client.name || '';
            document.getElementById('edit-client-contact').value = client.contact || '';
            document.getElementById('edit-client-email').value = client.email || '';
            document.getElementById('edit-client-phone').value = client.phone || '';
            document.getElementById('edit-client-notes').value = client.notes || '';
            document.getElementById('edit-client-status').value = client.status || 'Activo';
            openModal('edit-client');
        }

        function updateClient() {
            var id = document.getElementById('edit-client-id').value;
            var data = {
                name: document.getElementById('edit-client-name').value,
                contact: document.getElementById('edit-client-contact').value,
                email: document.getElementById('edit-client-email').value,
                phone: document.getElementById('edit-client-phone').value,
                notes: document.getElementById('edit-client-notes').value,
                status: document.getElementById('edit-client-status').value
            };

            fetch('/api/client/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    closeModal('edit-client');
                    loadClients();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function deleteClient(id) {
            if (!confirm('Eliminar este cliente?')) return;
            fetch('/api/client/' + id, { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else loadClients();
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        function populateProjectClientSelect() {
            // For add project modal - use client NAME as value (text field in Airtable)
            var addSelect = document.getElementById('new-project-client');
            if (addSelect) {
                var html = '<option value="">Sin cliente</option>';
                clients.forEach(function(c) {
                    html += '<option value="' + c.name + '">' + c.name + '</option>';
                });
                addSelect.innerHTML = html;
            }
            // For edit project modal
            var editSelect = document.getElementById('edit-project-client');
            if (editSelect) {
                var html = '<option value="">Sin cliente</option>';
                clients.forEach(function(c) {
                    html += '<option value="' + c.name + '">' + c.name + '</option>';
                });
                editSelect.innerHTML = html;
            }
        }

        // ==================== Transaction Category Assignment ====================

        function updateTransactionCategory(txId, category) {
            fetch('/api/transaction/' + txId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ category: category })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else {
                    // Update local data
                    transactions.forEach(function(t) { if (t.id === txId) t.category = category; });
                    renderPL();
                }
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        function updateTransactionProject(txId, projectId) {
            fetch('/api/transaction/' + txId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ project_id: projectId })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else {
                    transactions.forEach(function(t) { if (t.id === txId) t.project_id = projectId; });
                    renderProjects();
                }
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        function updateTransactionClient(txId, clientId) {
            fetch('/api/transaction/' + txId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ client_id: clientId })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) alert('Error: ' + result.error);
                else {
                    transactions.forEach(function(t) { if (t.id === txId) t.client_id = clientId; });
                }
            }).catch(function(e) { alert('Error: ' + e.message); });
        }

        // ==================== Transaction Allocations ====================

        function loadTransactionAllocations() {
            fetch('/api/transaction-allocations').then(function(r) { return r.json(); }).then(function(data) {
                transactionAllocations = data.allocations || [];
                renderTransactions();
            }).catch(function(e) {
                console.error('Error loading transaction allocations:', e);
            });
        }

        // ==================== Bulk Transaction Selection ====================
        function toggleTxSelection(txId) {
            var idx = selectedTransactions.indexOf(txId);
            if (idx === -1) {
                selectedTransactions.push(txId);
            } else {
                selectedTransactions.splice(idx, 1);
            }
            updateBulkActionsUI();
        }

        function toggleSelectAll(checked) {
            var checkboxes = document.querySelectorAll('.tx-checkbox');
            selectedTransactions = [];
            if (checked) {
                checkboxes.forEach(function(cb) {
                    selectedTransactions.push(cb.dataset.id);
                    cb.checked = true;
                });
            } else {
                checkboxes.forEach(function(cb) { cb.checked = false; });
            }
            updateBulkActionsUI();
        }

        function clearSelection() {
            selectedTransactions = [];
            document.getElementById('select-all-tx').checked = false;
            document.querySelectorAll('.tx-checkbox').forEach(function(cb) { cb.checked = false; });
            updateBulkActionsUI();
            renderTransactions();
        }

        function updateBulkActionsUI() {
            var count = selectedTransactions.length;
            document.getElementById('selected-count').textContent = count;
            var bulkActions = document.getElementById('bulk-actions');
            if (count > 0) {
                bulkActions.classList.remove('hidden');
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        var bulkAllocations = []; // Temporary allocations for bulk modal

        function openBulkAllocation() {
            if (selectedTransactions.length === 0) return;

            // Calculate total amount
            var totalAmount = 0;
            selectedTransactions.forEach(function(txId) {
                var tx = transactions.find(function(t) { return t.id === txId; });
                if (tx) totalAmount += Math.abs(parseFloat(tx.amount) || 0);
            });

            // Populate selects with grouped categories
            var catHtml = buildCategoryOptionsHtml();
            document.getElementById('bulk-alloc-category').innerHTML = catHtml;

            var projHtml = '<option value="">Sin proyecto</option>';
            projects.forEach(function(p) {
                projHtml += '<option value="' + p.id + '">' + p.name + '</option>';
            });
            document.getElementById('bulk-alloc-project').innerHTML = projHtml;

            var clientHtml = '<option value="">Sin cliente</option>';
            clients.forEach(function(c) {
                clientHtml += '<option value="' + c.id + '">' + c.name + '</option>';
            });
            document.getElementById('bulk-alloc-client').innerHTML = clientHtml;

            // Reset
            bulkAllocations = [];
            document.getElementById('bulk-alloc-category').value = '';
            document.getElementById('bulk-alloc-project').value = '';
            document.getElementById('bulk-alloc-client').value = '';
            document.getElementById('bulk-alloc-pct').value = '100';

            document.getElementById('bulk-alloc-count').textContent = selectedTransactions.length;
            document.getElementById('bulk-alloc-total-amount').textContent = fmt(totalAmount);
            renderBulkAllocationList();
            openModal('bulk-allocation');
        }

        function renderBulkAllocationList() {
            var container = document.getElementById('bulk-alloc-list');
            if (bulkAllocations.length === 0) {
                container.innerHTML = '<div class="text-muted" style="text-align:center;padding:16px;">Sin asignaciones. Agrega asignaciones abajo.</div>';
                document.getElementById('bulk-alloc-total-pct').textContent = '0%';
                document.getElementById('bulk-alloc-total-pct').style.color = 'inherit';
                return;
            }

            var html = '<table style="font-size:13px;width:100%;"><thead><tr><th>Cat. G4U</th><th>Proyecto</th><th>Cliente</th><th style="text-align:right">%</th><th></th></tr></thead><tbody>';
            var totalPct = 0;
            bulkAllocations.forEach(function(a, idx) {
                var catName = a.category || '-';
                var projName = '-';
                var clientName = '-';
                if (a.project_id) {
                    var proj = projects.find(function(p) { return p.id === a.project_id; });
                    if (proj) projName = proj.name;
                }
                if (a.client_id) {
                    var cli = clients.find(function(c) { return c.id === a.client_id; });
                    if (cli) clientName = cli.name;
                }
                totalPct += a.percentage;
                html += '<tr>';
                html += '<td>' + catName + '</td>';
                html += '<td>' + projName + '</td>';
                html += '<td>' + clientName + '</td>';
                html += '<td style="text-align:right">' + a.percentage + '%</td>';
                html += '<td><button class="btn btn-sm btn-outline" onclick="removeBulkAllocation(' + idx + ')" style="color:var(--danger);padding:2px 6px;">X</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('bulk-alloc-total-pct').textContent = Math.round(totalPct) + '%';
            document.getElementById('bulk-alloc-total-pct').style.color = totalPct === 100 ? 'var(--success)' : (totalPct > 100 ? 'var(--danger)' : 'inherit');
        }

        function addBulkAllocationRow() {
            var cat = document.getElementById('bulk-alloc-category').value;
            var proj = document.getElementById('bulk-alloc-project').value;
            var cli = document.getElementById('bulk-alloc-client').value;
            var pct = parseFloat(document.getElementById('bulk-alloc-pct').value) || 0;

            if (!cat && !proj && !cli) {
                alert('Selecciona al menos una categoria, proyecto o cliente');
                return;
            }
            if (pct <= 0 || pct > 100) {
                alert('El porcentaje debe estar entre 1 y 100');
                return;
            }

            bulkAllocations.push({
                category: cat || null,
                project_id: proj || null,
                client_id: cli || null,
                percentage: pct
            });

            // Reset form for next entry
            document.getElementById('bulk-alloc-category').value = '';
            document.getElementById('bulk-alloc-project').value = '';
            document.getElementById('bulk-alloc-client').value = '';
            var totalPct = bulkAllocations.reduce(function(sum, a) { return sum + a.percentage; }, 0);
            document.getElementById('bulk-alloc-pct').value = Math.max(0, 100 - totalPct);

            renderBulkAllocationList();
        }

        function removeBulkAllocation(idx) {
            bulkAllocations.splice(idx, 1);
            renderBulkAllocationList();
        }

        function applyBulkAllocations() {
            if (bulkAllocations.length === 0) {
                alert('Agrega al menos una asignacion');
                return;
            }

            var totalPct = bulkAllocations.reduce(function(sum, a) { return sum + a.percentage; }, 0);
            if (totalPct !== 100) {
                if (!confirm('El total es ' + Math.round(totalPct) + '% (no 100%). Continuar de todos modos?')) {
                    return;
                }
            }

            // Build all allocations to create
            var allAllocations = [];
            selectedTransactions.forEach(function(txId) {
                bulkAllocations.forEach(function(a) {
                    allAllocations.push({
                        transaction_id: txId,
                        category: a.category,
                        project_id: a.project_id,
                        client_id: a.client_id,
                        percentage: a.percentage
                    });
                });
            });

            // Show progress
            var statusEl = document.createElement('div');
            statusEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px 32px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:10001;text-align:center;';
            statusEl.innerHTML = '<div style="font-weight:600;margin-bottom:8px;">Procesando asignaciones...</div><div id="bulk-progress">0 / ' + allAllocations.length + '</div>';
            document.body.appendChild(statusEl);

            var completed = 0;
            var errors = 0;

            function processNext(index) {
                if (index >= allAllocations.length) {
                    document.body.removeChild(statusEl);
                    closeModal('bulk-allocation');
                    if (errors > 0) {
                        alert('Completado con ' + errors + ' errores. ' + completed + ' asignaciones creadas.');
                    } else {
                        alert('Asignaciones aplicadas: ' + completed + ' creadas');
                    }
                    clearSelection();
                    loadTransactionAllocations();
                    return;
                }

                var alloc = allAllocations[index];
                fetch('/api/transaction-allocation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(alloc)
                }).then(function(r) {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                }).then(function(result) {
                    if (result.error) {
                        errors++;
                    } else {
                        completed++;
                    }
                    document.getElementById('bulk-progress').textContent = (index + 1) + ' / ' + allAllocations.length;
                    setTimeout(function() { processNext(index + 1); }, 50);
                }).catch(function(e) {
                    errors++;
                    document.getElementById('bulk-progress').textContent = (index + 1) + ' / ' + allAllocations.length;
                    setTimeout(function() { processNext(index + 1); }, 200);
                });
            }

            processNext(0);
        }

        function toggleExcludeTransaction(txId, exclude) {
            fetch('/api/transaction/' + txId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_excluded: exclude })
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.ok) {
                    // Update local data
                    var tx = transactions.find(function(t) { return t.id === txId; });
                    if (tx) {
                        tx.is_excluded = exclude;
                    }
                    renderTransactions();
                } else {
                    alert('Error: ' + (result.error || 'No se pudo actualizar'));
                }
            })
            .catch(function(e) {
                alert('Error de conexion: ' + e.message);
            });
        }

        function openTxAllocation(txId) {
            currentAllocTxId = txId;
            var tx = transactions.find(function(t) { return t.id === txId; });
            if (!tx) return;

            // Set transaction info
            document.getElementById('tx-alloc-desc-input').value = tx.counterparty_name || tx.label || '';
            document.getElementById('tx-alloc-amount').textContent = fmt(tx.amount);

            // Populate category select with grouped options
            var catHtml = buildCategoryOptionsHtml();
            document.getElementById('tx-alloc-category').innerHTML = catHtml;

            // Populate project select
            var projHtml = '<option value="">Sin proyecto</option>';
            projects.forEach(function(p) {
                projHtml += '<option value="' + p.id + '">' + p.name + '</option>';
            });
            document.getElementById('tx-alloc-project').innerHTML = projHtml;

            // Populate client select
            var clientHtml = '<option value="">Sin cliente</option>';
            clients.forEach(function(c) {
                clientHtml += '<option value="' + c.id + '">' + c.name + '</option>';
            });
            document.getElementById('tx-alloc-client').innerHTML = clientHtml;

            // Reset form
            document.getElementById('tx-alloc-category').value = '';
            document.getElementById('tx-alloc-project').value = '';
            document.getElementById('tx-alloc-client').value = '';
            document.getElementById('tx-alloc-pct').value = '100';

            // Set VAT info
            var vatAmount = parseFloat(tx.vat_amount) || 0;
            var amount = Math.abs(parseFloat(tx.amount) || 0);

            // Try to determine VAT rate from existing VAT amount
            // Formula: vat_amount = amount × rate / (100 + rate)
            // Therefore: rate = (vat_amount × 100) / (amount - vat_amount)
            var vatRate = 0;
            if (vatAmount > 0 && amount > vatAmount) {
                var base = amount - vatAmount;
                var calculatedRate = (vatAmount * 100) / base;
                // Round to nearest common rate
                if (calculatedRate >= 19 && calculatedRate <= 23) vatRate = 21;
                else if (calculatedRate >= 8 && calculatedRate <= 12) vatRate = 10;
                else if (calculatedRate >= 3 && calculatedRate <= 5) vatRate = 4;
            }

            document.getElementById('tx-alloc-vat-rate').value = vatRate;
            updateVatDisplay(amount, vatRate, vatAmount);

            // Render current allocations
            renderTxAllocations();

            openModal('tx-allocation');
        }

        function updateVatDisplay(amount, vatRate, existingVat) {
            // Calculate VAT and base from rate
            // amount = base + vat, so base = amount / (1 + rate/100) = amount × 100 / (100 + rate)
            var vatAmount, base;
            if (vatRate > 0) {
                base = amount * 100 / (100 + vatRate);
                vatAmount = amount - base;
            } else if (existingVat > 0) {
                vatAmount = existingVat;
                base = amount - vatAmount;
            } else {
                vatAmount = 0;
                base = amount;
            }

            document.getElementById('tx-alloc-vat-amount').textContent = '€' + vatAmount.toFixed(2);
            document.getElementById('tx-alloc-base-amount').textContent = '€' + base.toFixed(2);
        }

        function updateVatFromRate() {
            if (!currentAllocTxId) return;

            var tx = transactions.find(function(t) { return t.id === currentAllocTxId; });
            if (!tx) return;

            var vatRate = parseFloat(document.getElementById('tx-alloc-vat-rate').value) || 0;
            var amount = Math.abs(parseFloat(tx.amount) || 0);

            // Calculate VAT: amount includes VAT, so VAT = amount × rate / (100 + rate)
            var vatAmount = 0;
            if (vatRate > 0) {
                vatAmount = amount * vatRate / (100 + vatRate);
            }

            updateVatDisplay(amount, vatRate, 0);

            // Save to Airtable
            fetch('/api/transaction/' + currentAllocTxId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    vat_rate: vatRate,
                    amount: tx.amount  // Pass amount for calculation
                })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error guardando IVA: ' + result.error);
                } else {
                    // Update local data
                    tx.vat_amount = vatAmount;
                    renderTransactions();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function saveTxDescription() {
            var newDesc = document.getElementById('tx-alloc-desc-input').value.trim();
            if (!newDesc || !currentAllocTxId) return;

            fetch('/api/transaction/' + currentAllocTxId, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ counterparty_name: newDesc })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    // Update local data
                    var tx = transactions.find(function(t) { return t.id === currentAllocTxId; });
                    if (tx) tx.counterparty_name = newDesc;
                    renderTransactions();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function renderTxAllocations() {
            var txAllocs = transactionAllocations.filter(function(a) { return a.transaction_id === currentAllocTxId; });
            var container = document.getElementById('tx-alloc-list');

            if (txAllocs.length === 0) {
                container.innerHTML = '<div class="text-muted" style="text-align:center;padding:16px;">Sin asignaciones. Usa el formulario abajo para asignar categoria, proyecto y/o cliente.</div>';
                document.getElementById('tx-alloc-total-pct').textContent = '0%';
                return;
            }

            var html = '<table style="font-size:13px;width:100%;"><thead><tr><th>Cat. G4U</th><th>Proyecto</th><th>Cliente</th><th style="text-align:right">%</th><th></th></tr></thead><tbody>';
            var totalPct = 0;
            txAllocs.forEach(function(a) {
                var catName = a.category || '-';
                var projName = '-';
                var clientName = '-';
                if (a.project_id) {
                    var proj = projects.find(function(p) { return p.id === a.project_id; });
                    if (proj) projName = proj.name;
                }
                if (a.client_id) {
                    var client = clients.find(function(c) { return c.id === a.client_id; });
                    if (client) clientName = client.name;
                }
                totalPct += a.percentage;
                html += '<tr>';
                html += '<td>' + catName + '</td>';
                html += '<td>' + projName + '</td>';
                html += '<td>' + clientName + '</td>';
                html += '<td style="text-align:right">' + a.percentage + '%</td>';
                html += '<td><button class="btn btn-sm btn-outline" onclick="deleteTxAllocation(\'' + a.id + '\')" style="color:var(--danger);padding:2px 6px;">X</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('tx-alloc-total-pct').textContent = totalPct + '%';
            document.getElementById('tx-alloc-total-pct').style.color = totalPct === 100 ? 'var(--success)' : (totalPct > 100 ? 'var(--danger)' : 'inherit');
        }

        function addTransactionAllocation() {
            var category = document.getElementById('tx-alloc-category').value;
            var projectId = document.getElementById('tx-alloc-project').value;
            var clientId = document.getElementById('tx-alloc-client').value;
            var percentage = parseFloat(document.getElementById('tx-alloc-pct').value) || 0;

            if (!category && !projectId && !clientId) {
                alert('Selecciona al menos una categoria, proyecto o cliente');
                return;
            }
            if (percentage <= 0 || percentage > 100) {
                alert('El porcentaje debe estar entre 1 y 100');
                return;
            }

            fetch('/api/transaction-allocation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transaction_id: currentAllocTxId,
                    category: category || '',
                    project_id: projectId || null,
                    client_id: clientId || null,
                    percentage: percentage
                })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    // Add to local array immediately for instant UI feedback
                    transactionAllocations.push({
                        id: result.id || 'temp_' + Date.now(),
                        transaction_id: currentAllocTxId,
                        category: category || '',
                        project_id: projectId || null,
                        client_id: clientId || null,
                        percentage: percentage
                    });
                    renderTxAllocations();
                    renderTransactions();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function deleteTxAllocation(id) {
            if (!confirm('Eliminar esta asignacion?')) return;

            // Check if it's a temporary ID (created locally but not yet synced)
            if (id && id.toString().startsWith('temp_')) {
                // Just remove from local array - it was never saved to the server
                transactionAllocations = transactionAllocations.filter(function(a) {
                    return a.id !== id;
                });
                renderTxAllocations();
                renderTransactions();
                return;
            }

            fetch('/api/transaction-allocation/' + id, {
                method: 'DELETE'
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.error) {
                    // If error, try to remove locally anyway (might be already deleted on server)
                    console.warn('Error deleting allocation:', result.error);
                    transactionAllocations = transactionAllocations.filter(function(a) {
                        return a.id !== id;
                    });
                    renderTxAllocations();
                    renderTransactions();
                } else {
                    // Remove from local array immediately for instant UI feedback
                    transactionAllocations = transactionAllocations.filter(function(a) {
                        return a.id !== id;
                    });
                    renderTxAllocations();
                    renderTransactions();
                }
            }).catch(function(e) {
                console.error('Error deleting allocation:', e);
                // On network error, try to remove locally anyway
                transactionAllocations = transactionAllocations.filter(function(a) {
                    return a.id !== id;
                });
                renderTxAllocations();
                renderTransactions();
            });
        }

        // ==================== Qonto Extended Sync ====================

        function syncQontoMembers() {
            if (!confirm('Importar miembros del equipo desde Qonto? (Los existentes no se duplicaran)')) return;

            fetch('/api/qonto/sync-members', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    var msg = 'Miembros en Qonto: ' + data.qonto_memberships + '\n';
                    msg += 'Miembros creados: ' + data.created + '\n';
                    msg += 'Ya existian: ' + data.skipped + '\n\n';
                    msg += 'Nota: Los salarios se importan en 0, debes actualizarlos manualmente.';
                    alert(msg);
                    loadTeamMembers();
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function loadQontoOrganization() {
            fetch('/api/qonto/organization')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    document.getElementById('qonto-org-name').textContent = data.legal_name || data.slug || '-';
                    var balance = 0;
                    if (data.bank_accounts && data.bank_accounts.length > 0) {
                        balance = data.bank_accounts[0].balance || 0;
                    }
                    document.getElementById('qonto-balance').textContent = fmt(balance);
                    document.getElementById('qonto-org-info').style.display = 'block';
                }
            }).catch(function(e) {
                alert('Error: ' + e.message);
            });
        }

        function autoSync() {
            document.getElementById('last-sync').textContent = 'Sincronizando...';
            fetch('/api/sync', {method: 'POST'}).then(function(r) { return r.json(); }).then(function(data) {
                var now = new Date();
                document.getElementById('last-sync').textContent = 'Sync: ' + now.toLocaleTimeString();
                loadData();
            }).catch(function(e) {
                document.getElementById('last-sync').textContent = 'Sync error';
                console.error('Auto sync error:', e);
            });
        }

        function loadQontoOrgAuto() {
            fetch('/api/qonto/organization').then(function(r) { return r.json(); }).then(function(data) {
                if (!data.error) {
                    document.getElementById('qonto-org-name').textContent = data.legal_name || data.slug || '-';
                    qontoBalance = 0;
                    if (data.bank_accounts && data.bank_accounts.length > 0) {
                        qontoBalance = data.bank_accounts[0].balance || 0;
                    }
                    document.getElementById('qonto-balance').textContent = fmt(qontoBalance);
                    renderKPIs();
                }
            }).catch(function(e) {
                console.error('Error loading org:', e);
            });
        }

        // Init - Load data in optimal order
        console.log('G4U Finance Dashboard v7 - Business Overview');

        // First: Load all cached data from Airtable in parallel (fast)
        Promise.all([
            fetch('/api/data').then(function(r) { return r.json(); }),
            fetch('/api/clients').then(function(r) { return r.json(); }),
            fetch('/api/projects').then(function(r) { return r.json(); }),
            fetch('/api/categories').then(function(r) { return r.json(); }),
            fetch('/api/team-members').then(function(r) { return r.json(); }),
            fetch('/api/transaction-allocations').then(function(r) { return r.json(); }),
            fetch('/api/excluded-transactions').then(function(r) { return r.json(); }),
            fetch('/api/settings/offerings').then(function(r) { return r.json(); })
        ]).then(function(results) {
            // Process main data
            var data = results[0];
            if (!data.error) {
                transactions = data.transactions || [];
                categories = data.categories || [];
                projects = data.projects || [];
            }

            // Process clients
            var clientsData = results[1];
            if (!clientsData.error) {
                clients = clientsData.clients || [];
            }

            // Process projects (may have more detail)
            var projectsData = results[2];
            if (!projectsData.error && projectsData.projects) {
                projects = projectsData.projects;
            }

            // Process categories
            var catsData = results[3];
            if (!catsData.error && catsData.categories) {
                categories = catsData.categories;
            }

            // Process team members
            var teamData = results[4];
            if (!teamData.error) {
                teamMembers = teamData.members || [];
            }

            // Process allocations
            var allocData = results[5];
            if (!allocData.error) {
                transactionAllocations = allocData.allocations || [];
            }

            // Process excluded transactions
            var excludedData = results[6];
            if (!excludedData.error) {
                var excludedIds = excludedData.excluded || [];
                // Mark transactions as excluded
                transactions.forEach(function(t) {
                    t.is_excluded = excludedIds.indexOf(t.id) !== -1;
                });
            }

            // Process offerings (Ofertas G4U)
            var offeringsData = results[7];
            if (!offeringsData.error) {
                offerings = offeringsData.offerings || [];
                console.log('Loaded', offerings.length, 'offerings from', offeringsData.source || 'unknown');
            }

            // Now render everything
            populateTransactionFilters();
            applyFilters();
            renderAll();
            renderTeamMembers();
            renderClientsSettings();
            renderProjectsSettings();
            renderCategoriesSettings();

            console.log('Data loaded:', transactions.length, 'transactions');

            // Then: Sync from Qonto in background (slower)
            setTimeout(function() {
                autoSync();
            }, 500);
        }).catch(function(e) {
            console.error('Error loading initial data:', e);
            // Fallback to individual loads
            loadData();
            loadClients();
            loadTeamMembers();
            loadTransactionAllocations();
        });

        // Status check (fast, independent)
        checkStatus();
        loadQontoOrgAuto();
        loadAISettings();
    </script>
</body>
</html>
